<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: #f5f7fa; }
        
        .header {
            background-color: #1c2940;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: white;
            color: #1c2940;
        }
        
        .btn-primary:hover {
            background-color: #e8eaf0;
        }
        
        .container {
            max-width: 98%;
            margin: 1rem auto;
            padding: 0 0.5rem;
        }
        
        .upload-section {
            background: white;
            padding: 3rem 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-family: 'Montserrat', sans-serif;
            color: #1c2940;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }
        
        .section-subtitle {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        
        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 4rem 2rem;
            background-color: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drop-zone:hover {
            border-color: #64748b;
            background-color: #f1f5f9;
        }
        
        .drop-zone.drag-over {
            border-color: #1c2940;
            background-color: #e0e7ff;
            border-width: 3px;
        }
        
        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.25rem;
            pointer-events: none;
        }
        
        .drop-zone-icon { color: #94a3b8; }
        .drop-zone.drag-over .drop-zone-icon { color: #1c2940; }
        
        .drop-zone-text {
            color: #64748b;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .drop-zone.drag-over .drop-zone-text { color: #1c2940; }
        
        .or-text {
            color: #94a3b8;
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }
        
        .file-input-wrapper { position: relative; display: inline-block; }
        .file-input-wrapper input[type="file"] { display: none; }
        
        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 2rem;
            background-color: #1c2940;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.2s;
            pointer-events: auto;
        }
        
        .file-input-label:hover {
            background-color: #2a3d5f;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(28, 41, 64, 0.3);
        }
        
        .format-text {
            color: #94a3b8;
            font-size: 0.85rem;
            margin-top: 1rem;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active { display: flex; }
        
        .loading-content {
            background: white;
            padding: 2rem 3rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 1rem;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #1c2940;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #1c2940;
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .loading-subtext {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        /* Á∑èÂêà„Ç≥„É≥„Éà„É≠„Éº„É´„Ç®„É™„Ç¢ */
        .control-section {
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 2rem;
            color: white;
        }
        
        .control-section.active { display: flex; }
        
        .control-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .total-summary {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
        }
        
        .summary-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
        }
        
        .data-section {
            display: none;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .data-section.active { display: block; }
        
        .data-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .data-section-title { flex: 1; }
        
        .data-section-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .total-items {
            font-size: 0.9rem;
            color: #1c2940;
            font-weight: 600;
            padding: 0.5rem 1rem;
            background-color: #f3f4f6;
            border-radius: 6px;
        }
        
        .data-table-wrapper {
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            table-layout: fixed;
        }
        
        .data-table th {
            background-color: #1c2940;
            color: white;
            padding: 0.6rem 0.4rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .data-table th:nth-child(1) { width: 8%; }
        .data-table th:nth-child(2) { width: 7%; }
        .data-table th:nth-child(3) { width: 8%; }
        .data-table th:nth-child(4) { width: 9%; }
        .data-table th:nth-child(5) { width: 18%; }
        .data-table th:nth-child(6) { width: 13%; }
        .data-table th:nth-child(7) { width: 9%; }
        .data-table th:nth-child(8) { width: 13%; }
        .data-table th:nth-child(9) { width: 15%; }
        
        .data-table td {
            padding: 0.6rem 0.4rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table tbody tr:hover {
            background-color: #f9fafb;
        }
        
        .data-table input,
        .data-table select {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }
        
        .data-table input:focus,
        .data-table select:focus {
            outline: none;
            border-color: #1c2940;
        }
        
        .data-table input[readonly] {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        
        .data-table input.align-right {
            text-align: right;
        }
        
        .needs-review {
            background-color: #fef3c7 !important;
            border: 2px solid #f59e0b !important;
        }
        
        /* HS„Ç≥„Éº„ÉâÂà§ÂÆö„Éè„Ç§„É©„Ç§„Éà - „Éá„Éï„Ç©„É´„Éà„ÅÆ„Åø */
        .hs-match-default {
            background-color: #f8d7da !important;
        }
        
        .btn-add-row {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }
        
        .btn-add-row:hover {
            background-color: #059669;
        }
        
        .btn-generate {
            padding: 0.75rem 2rem;
            background-color: white;
            color: #667eea;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-generate:hover {
            background-color: rgba(255,255,255,0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
        
        /* Non-Commercial Table */
        .nc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .nc-table th {
            background-color: #1c2940;
            color: white;
            padding: 0.6rem 0.8rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .nc-table td {
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .nc-table input {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-family: 'Montserrat', sans-serif;
            color: #1c2940;
            font-size: 1.25rem;
        }
        
        .btn-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: #6b7280;
            transition: color 0.2s;
        }
        
        .btn-close:hover { color: #1c2940; }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .preset-item {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr auto;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            align-items: center;
            background-color: #f9fafb;
        }
        
        .preset-item input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }
        
        .preset-item label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .btn-delete {
            background-color: transparent;
            color: #9ca3af;
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-delete:hover {
            background-color: #f3f4f6;
            color: #6b7280;
            border-color: #d1d5db;
        }
        
        .btn-add {
            width: 100%;
            padding: 0.75rem;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 1rem;
            transition: background-color 0.2s;
        }
        
        .btn-add:hover { background-color: #059669; }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover { background-color: #d1d5db; }
        
        .btn-save {
            background-color: #1c2940;
            color: white;
        }
        
        .btn-save:hover { background-color: #2a3d5f; }
        
        .debug-summary {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        .debug-summary h4 {
            color: #60a5fa;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-title">
            <i data-lucide="package" size="28"></i>
            Invoice Generator
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openPresetModal()">
                <i data-lucide="settings" size="18"></i>
                Manage Presets
            </button>
        </div>
    </header>
    
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Âá¶ÁêÜ‰∏≠... / Processing...</div>
            <div class="loading-subtext">„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô / Reading file</div>
        </div>
    </div>
    
    <div class="container">
        <div id="uploadSection" class="upload-section">
            <h2 class="section-title">ÂïÜÂìÅÊòéÁ¥∞„ÅÆ„Ç®„ÇØ„Çª„É´„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h2>
            <p class="section-subtitle">Upload Product List Excel File</p>
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-content">
                    <div class="drop-zone-icon">
                        <i data-lucide="file-spreadsheet" size="56"></i>
                    </div>
                    <p class="drop-zone-text">„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó / Drag & Drop File</p>
                    <p class="or-text">„Åæ„Åü„ÅØ / or</p>
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" accept=".xlsx,.xls">
                        <label for="fileInput" class="file-input-label">
                            <i data-lucide="upload" size="20"></i>
                            Choose File
                        </label>
                    </div>
                    <p class="format-text">.xlsx „Åæ„Åü„ÅØ .xls ÂΩ¢Âºè / .xlsx or .xls format</p>
                </div>
            </div>
        </div>
        
        <div id="debugSummary" class="debug-summary" style="display: none;"></div>
        
        <!-- Á∑èÂêà„Ç≥„É≥„Éà„É≠„Éº„É´ -->
        <div id="controlSection" class="control-section">
            <div class="control-content">
                <div class="total-summary">
                    <div class="summary-item">
                        <span class="summary-label">ÂÖ®‰ΩìÂêàË®àÁÇπÊï∞ / Total Items</span>
                        <span class="summary-value" id="grandTotalItems">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Ë´ãÊ±ÇÈáëÈ°ç / Invoice Amount</span>
                        <span class="summary-value" id="grandTotalAmount">JPY 0</span>
                    </div>
                </div>
                <button class="btn-generate" onclick="generateInvoice()">
                    <i data-lucide="file-text" size="20"></i>
                    „Ç§„É≥„Éú„Ç§„Çπ„ÇíÁîüÊàê
                </button>
            </div>
        </div>
        
        <!-- Container 1: ÂïÜÂìÅÊòéÁ¥∞„É™„Çπ„Éà -->
        <div id="dataSection" class="data-section">
            <div class="data-section-header">
                <div class="data-section-title">
                    <h2 class="section-title">ÂïÜÂìÅÊòéÁ¥∞„É™„Çπ„Éà / Product Details List</h2>
                    <p class="section-subtitle">Á∑®ÈõÜÂèØËÉΩ„Åß„Åô / Editable</p>
                </div>
                <div class="data-section-info">
                    <div class="total-items">
                        ÂêàË®àÁÇπÊï∞ / Total: <span id="totalItemsCount1">0</span>
                    </div>
                </div>
            </div>
            
            <div class="data-table-wrapper">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>No. of Units</th>
                            <th>Net Weight (KG)</th>
                            <th>Unit of Measure</th>
                            <th>Description of Goods</th>
                            <th>Harmonized Tariff Number</th>
                            <th>Country/Terr. of MFR</th>
                            <th>Unit Value (JPY)</th>
                            <th>Total Value (JPY)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Container 2: No Commercial Value Items -->
        <div id="noCommercialSection" class="data-section">
            <div class="data-section-header">
                <div class="data-section-title">
                    <h2 class="section-title">No Commercial Value Items</h2>
                    <p class="section-subtitle">„Ç´„Çø„É≠„Ç∞„ÉªË≤©‰øÉÁâ©„Å™„Å© / Catalogs, Promotional Materials</p>
                </div>
                <div class="data-section-info">
                    <div class="total-items">
                        ÂêàË®àÁÇπÊï∞ / Total: <span id="totalItemsCount2">0</span>
                    </div>
                </div>
            </div>
            
            <div class="data-table-wrapper">
                <table class="data-table" id="noCommercialTable">
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>No. of Units</th>
                            <th>Net Weight (KG)</th>
                            <th>Unit of Measure</th>
                            <th>Description of Goods</th>
                            <th>Harmonized Tariff Number</th>
                            <th>Country/Terr. of MFR</th>
                            <th>Unit Value (JPY)</th>
                            <th>Total Value (JPY)</th>
                        </tr>
                    </thead>
                    <tbody id="noCommercialBody"></tbody>
                </table>
            </div>
            
            <button class="btn-add-row" onclick="addNoCommercialRow()">
                <i data-lucide="plus" size="16"></i>
                Ë°å„ÇíËøΩÂä† / Add Row
            </button>
        </div>
        
        <!-- Container 3: Non-Commercial Items -->
        <div id="nonCommercialSection" class="data-section">
            <div class="data-section-header">
                <div class="data-section-title">
                    <h2 class="section-title">Non-Commercial Items</h2>
                    <p class="section-subtitle">ÁÑ°ÂÑü„Çµ„É≥„Éó„É´„Éª„ÇÆ„Éï„Éà„Å™„Å© / Free Samples, Gifts (ÈáëÈ°ç„Å´Âê´„Åæ„Çå„Åæ„Åõ„Çì / Not included in invoice amount)</p>
                </div>
                <div class="data-section-info">
                    <div class="total-items">
                        ÂêàË®àÁÇπÊï∞ / Total: <span id="totalItemsCount3">0</span>
                    </div>
                </div>
            </div>
            
            <div class="data-table-wrapper">
                <table class="nc-table" id="nonCommercialTable">
                    <thead>
                        <tr>
                            <th style="width: 70%;">Description</th>
                            <th style="width: 30%;">Quantity</th>
                        </tr>
                    </thead>
                    <tbody id="nonCommercialBody"></tbody>
                </table>
            </div>
            
            <button class="btn-add-row" onclick="addNonCommercialRow()">
                <i data-lucide="plus" size="16"></i>
                Ë°å„ÇíËøΩÂä† / Add Row
            </button>
        </div>
    </div>
    
    <div id="presetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Preset Goods</h3>
                <button class="btn-close" onclick="closePresetModal()">
                    <i data-lucide="x" size="24"></i>
                </button>
            </div>
            <div class="modal-body" id="presetList"></div>
            <div style="padding: 0 1.5rem;">
                <button class="btn-add" onclick="addNewPreset()">
                    <i data-lucide="plus" size="18"></i> Add New Preset
                </button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePresetModal()">Cancel</button>
                <button class="btn btn-save" onclick="savePresets()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        lucide.createIcons();
        
        const ITEM_WEIGHT_MAP = {
            "„Éñ„É´„Çæ„É≥„Éª„Ç∏„É£„Ç±„ÉÉ„Éà": 0.8,
            "„Ç≥„Éº„Éà": 1.2,
            "„Ç∑„É£„ÉÑ": 0.3,
            "„Çπ„Ç´„Éº„Éà": 0.4,
            "„ÉØ„É≥„Éî„Éº„Çπ": 0.5,
            "„Éë„É≥„ÉÑ": 0.5,
            "„Ç´„ÉÉ„Éà„ÇΩ„Éº": 0.3,
            "„Éã„ÉÉ„Éà": 0.4,
            "„Ç∞„ÉÉ„Ç∫": 0.2
        };
        
        const ITEM_CATEGORY_TRANSLATION = {
            "„Éñ„É´„Çæ„É≥„Éª„Ç∏„É£„Ç±„ÉÉ„Éà": "Jacket",
            "„Ç≥„Éº„Éà": "Coat",
            "„Ç∑„É£„ÉÑ": "Shirt",
            "„Çπ„Ç´„Éº„Éà": "Skirt",
            "„ÉØ„É≥„Éî„Éº„Çπ": "Dress",
            "„Éë„É≥„ÉÑ": "Pants",
            "„Ç´„ÉÉ„Éà„ÇΩ„Éº": "Knit Top",
            "„Éã„ÉÉ„Éà": "Knit Top",
            "„Ç∞„ÉÉ„Ç∫": "Goods"
        };
        
        const MATERIAL_BUCKETS = {
            '„Ç¶„Éº„É´': 'Wool', 'ÊØõ': 'Wool', '„Ç¢„É´„Éë„Ç´': 'Wool', 'WOOL': 'Wool',
            '„Ç´„Ç∑„Éü„É§': 'Cashmere', '„Ç´„Ç∑„Éü„Ç¢': 'Cashmere', 'CASHMERE': 'Cashmere',
            '„Ç≥„ÉÉ„Éà„É≥': 'Cotton', 'Á∂ø': 'Cotton', 'COTTON': 'Cotton',
            '„Éù„É™„Ç®„Çπ„ÉÜ„É´': 'Synthetic', '„Éä„Ç§„É≠„É≥': 'Synthetic', '„Ç¢„ÇØ„É™„É´': 'Synthetic', 'POLYESTER': 'Synthetic', 'NYLON': 'Synthetic',
            '„É¨„Éº„É®„É≥': 'Artificial', 'RAYON': 'Artificial', 'VISCOSE': 'Artificial',
            '„Ç∑„É´„ÇØ': 'Silk', 'Áµπ': 'Silk', 'SILK': 'Silk',
            '„Éá„Éã„É†': 'Denim', 'DENIM': 'Denim',
            '„É¨„Ç∂„Éº': 'Leather', 'LEATHER': 'Leather'
        };
        
        const HS_CODE_RULES = {
            "Jacket-Knit-M-Wool": "61033100",
            "Jacket-Knit-M-Cotton": "61033200",
            "Jacket-Knit-M-Synthetic": "61033300",
            "Jacket-Knit-W-Wool": "61043100",
            "Jacket-Knit-W-Cotton": "61043200",
            "Jacket-Knit-W-Synthetic": "61043300",
            "Jacket-Woven-M-Wool": "62033100",
            "Jacket-Woven-M-Cotton": "62033290",
            "Jacket-Woven-M-Synthetic": "62033300",
            "Jacket-Woven-W-Wool": "62043100",
            "Jacket-Woven-W-Cotton": "62043290",
            "Jacket-Woven-W-Synthetic": "62043300",
            "Coat-Knit-M-Wool": "61019010",
            "Coat-Knit-M-Cotton": "61012000",
            "Coat-Knit-W-Wool": "61021000",
            "Coat-Knit-W-Cotton": "61022000",
            "Coat-Woven-M-Wool": "62012000",
            "Coat-Woven-M-Cotton": "62013090",
            "Coat-Woven-W-Wool": "62022000",
            "Coat-Woven-W-Cotton": "62023090",
            "Shirt-Woven-M-Cotton": "62052020",
            "Shirt-Woven-M-Synthetic": "62053010",
            "Shirt-Woven-W-Cotton": "62063010",
            "Shirt-Woven-W-Synthetic": "62064010",
            "Knit Top-Knit-M-Cotton": "61091010",
            "Knit Top-Knit-M-Synthetic": "61099010",
            "Knit Top-Knit-W-Cotton": "61091010",
            "Knit Top-Knit-W-Synthetic": "61099010",
            "Skirt-Knit-W-Cotton": "61045200",
            "Skirt-Knit-W-Synthetic": "61045300",
            "Skirt-Woven-W-Cotton": "62045290",
            "Skirt-Woven-W-Synthetic": "62045300",
            "Dress-Knit-W-Cotton": "61044200",
            "Dress-Knit-W-Synthetic": "61044300",
            "Dress-Woven-W-Cotton": "62044290",
            "Dress-Woven-W-Synthetic": "62044300",
            "Pants-Knit-M-Cotton": "61034210",
            "Pants-Knit-M-Synthetic": "61034310",
            "Pants-Knit-W-Cotton": "61046210",
            "Pants-Knit-W-Synthetic": "61046310",
            "Pants-Woven-M-Cotton": "62034240",
            "Pants-Woven-M-Synthetic": "62034319",
            "Pants-Woven-W-Cotton": "62046280",
            "Pants-Woven-W-Synthetic": "62046310",
            "Goods": "42029260"
        };
        
        const GOODS_KEYWORDS = {
            "„ÉÅ„Éß„Éº„Ç´„Éº": "Necklace", "„É™„Éú„É≥": "Necklace", "„Éç„ÉÉ„ÇØ„É¨„Çπ": "Necklace",
            "„Ç§„É§„É™„É≥„Ç∞": "Earrings", "„Éê„É≥„Ç∞„É´": "Bracelet", "„Éñ„É¨„Çπ„É¨„ÉÉ„Éà": "Bracelet",
            "„Éê„É≥„ÉÄ„Éä": "Scarf", "„Éû„Éï„É©„Éº": "Scarf", "Furoshikii": "Scarf",
            "„Éù„É≥„ÉÅ„Éß": "Scarf", "Tie": "Scarf", "„Çø„Ç§": "Scarf",
            "„ÉØ„Ç´„É°": "Scarf", "„Åì„Çì„Å∂": "Scarf", "È¢®ÂëÇÊï∑": "Scarf",
            "„Éç„ÇØ„Çø„Ç§": "Scarf", "„Çπ„Éà„Éº„É´": "Scarf",
            "„Ç≠„É£„ÉÉ„Éó": "Hat", "„Éè„ÉÉ„Éà": "Hat", "„Éã„ÉÉ„ÉàÂ∏Ω": "Hat",
            "„Éò„Ç¢„Éê„É≥„Éâ": "Hat", "„Éô„É¨„Éº": "Hat", "Â∏ΩÂ≠ê": "Hat", "Cap": "Hat",
            "„ÇΩ„ÉÉ„ÇØ„Çπ": "Socks", "Èù¥‰∏ã": "Socks",
            "„Éà„Éº„Éà": "Bag", "„Éà„Éº„Éà„Éê„ÉÉ„Ç∞": "Bag", "„Éê„ÉÉ„Ç∞": "Bag",
            "„Éù„Éº„ÉÅ": "Bag", "Bag": "Bag",
            "„Éô„É´„Éà": "Belt", "Belt": "Belt",
            "Êó•ÂÇò": "Umbrella", "ÂÇò": "Umbrella",
            "„Ç∑„É•„Éº„Ç∫": "Shoes", "Èù¥": "Shoes",
            "„Ç≠„Éº„Éõ„É´„ÉÄ„Éº": "Key Holder", "„Ç≠„Éº„É™„É≥„Ç∞": "Key Holder"
        };
        
        const DEFAULT_PRESETS = {
            "Paper Catalog": { hs_code: "49019900", unit_value: 100 },
            "Calendar": { hs_code: "49100000", unit_value: 50 },
            "Tote Bag": { hs_code: "42029260", unit_value: 200 },
            "Cotton Materials": { hs_code: "52093900", unit_value: 150 },
            "Gift Box": { hs_code: "48191000", unit_value: 80 },
            "Red Pocket": { hs_code: "48171000", unit_value: 30 }
        };
        
        let presets = JSON.parse(localStorage.getItem('invoicePresets')) || DEFAULT_PRESETS;
        let productData = [];
        let noCommercialData = [];
        let nonCommercialData = [];
        
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        function calculatePrice(originalPrice) {
            return Math.round((originalPrice * 0.42) / 10) * 10;
        }
        
        function getWeightByCategory(category) {
            return ITEM_WEIGHT_MAP[category] || 0.5;
        }
        
        function translateCategory(category) {
            return ITEM_CATEGORY_TRANSLATION[category] || category;
        }
        
        function toFullWidth(str) {
            if (!str) return '';
            
            let result = str;
            
            const dakuten = {
                'ÔΩ∂Ôæû': '„Ç¨', 'ÔΩ∑Ôæû': '„ÇÆ', 'ÔΩ∏Ôæû': '„Ç∞', 'ÔΩπÔæû': '„Ç≤', 'ÔΩ∫Ôæû': '„Ç¥',
                'ÔΩªÔæû': '„Ç∂', 'ÔΩºÔæû': '„Ç∏', 'ÔΩΩÔæû': '„Ç∫', 'ÔΩæÔæû': '„Çº', 'ÔΩøÔæû': '„Çæ',
                'ÔæÄÔæû': '„ÉÄ', 'ÔæÅÔæû': '„ÉÇ', 'ÔæÇÔæû': '„ÉÖ', 'ÔæÉÔæû': '„Éá', 'ÔæÑÔæû': '„Éâ',
                'ÔæäÔæû': '„Éê', 'ÔæãÔæû': '„Éì', 'ÔæåÔæû': '„Éñ', 'ÔæçÔæû': '„Éô', 'ÔæéÔæû': '„Éú',
                'ÔæäÔæü': '„Éë', 'ÔæãÔæü': '„Éî', 'ÔæåÔæü': '„Éó', 'ÔæçÔæü': '„Éö', 'ÔæéÔæü': '„Éù',
                'ÔΩ≥Ôæû': '„É¥'
            };
            
            for (const [half, full] of Object.entries(dakuten)) {
                result = result.split(half).join(full);
            }
            
            const kanaMap = {
                'ÔΩß': '„Ç°', 'ÔΩ±': '„Ç¢', 'ÔΩ®': '„Ç£', 'ÔΩ≤': '„Ç§', 'ÔΩ©': '„Ç•', 'ÔΩ≥': '„Ç¶', 'ÔΩ™': '„Çß', 'ÔΩ¥': '„Ç®', 'ÔΩ´': '„Ç©', 'ÔΩµ': '„Ç™',
                'ÔΩ∂': '„Ç´', 'ÔΩ∑': '„Ç≠', 'ÔΩ∏': '„ÇØ', 'ÔΩπ': '„Ç±', 'ÔΩ∫': '„Ç≥',
                'ÔΩª': '„Çµ', 'ÔΩº': '„Ç∑', 'ÔΩΩ': '„Çπ', 'ÔΩæ': '„Çª', 'ÔΩø': '„ÇΩ',
                'ÔæÄ': '„Çø', 'ÔæÅ': '„ÉÅ', 'ÔΩØ': '„ÉÉ', 'ÔæÇ': '„ÉÑ', 'ÔæÉ': '„ÉÜ', 'ÔæÑ': '„Éà',
                'ÔæÖ': '„Éä', 'ÔæÜ': '„Éã', 'Ôæá': '„Éå', 'Ôæà': '„Éç', 'Ôæâ': '„Éé',
                'Ôæä': '„Éè', 'Ôæã': '„Éí', 'Ôæå': '„Éï', 'Ôæç': '„Éò', 'Ôæé': '„Éõ',
                'Ôæè': '„Éû', 'Ôæê': '„Éü', 'Ôæë': '„É†', 'Ôæí': '„É°', 'Ôæì': '„É¢',
                'ÔΩ¨': '„É£', 'Ôæî': '„É§', 'ÔΩ≠': '„É•', 'Ôæï': '„É¶', 'ÔΩÆ': '„Éß', 'Ôæñ': '„É®',
                'Ôæó': '„É©', 'Ôæò': '„É™', 'Ôæô': '„É´', 'Ôæö': '„É¨', 'Ôæõ': '„É≠',
                'Ôæú': '„ÉØ', 'ÔΩ¶': '„É≤', 'Ôæù': '„É≥',
                'ÔΩ∞': '„Éº'
            };
            
            for (const [half, full] of Object.entries(kanaMap)) {
                result = result.split(half).join(full);
            }
            
            return result;
        }
        
        function normalizeMaterial(materialText) {
            if (!materialText) return "Other";
            const material = materialText.toString().toUpperCase().trim();
            
            for (const [keyword, bucket] of Object.entries(MATERIAL_BUCKETS)) {
                if (material.includes(keyword.toUpperCase())) {
                    return bucket;
                }
            }
            return "Other";
        }
        
        function determineKnitWoven(item, productName) {
            const itemLower = (item || '').toLowerCase();
            const nameLower = toFullWidth(productName || '').toLowerCase();
            const combined = itemLower + ' ' + nameLower;
            
            console.log(`[Knit/Woven] Item: ${item}, Name: ${productName}`);
            
            if (itemLower.includes('„Ç∑„É£„ÉÑ'.toLowerCase())) {
                console.log('  ‚Üí item_rule: Woven („Ç∑„É£„ÉÑ)');
                return { result: 'Woven', matchType: 'item_rule' };
            }
            if (itemLower.includes('„Ç´„ÉÉ„Éà„ÇΩ„Éº'.toLowerCase()) || itemLower.includes('„Éã„ÉÉ„Éà'.toLowerCase())) {
                console.log('  ‚Üí item_rule: Knit („Ç´„ÉÉ„Éà„ÇΩ„Éº/„Éã„ÉÉ„Éà)');
                return { result: 'Knit', matchType: 'item_rule' };
            }
            if (itemLower.includes('„Ç∞„ÉÉ„Ç∫'.toLowerCase())) {
                console.log('  ‚Üí item_rule: N/A („Ç∞„ÉÉ„Ç∫)');
                return { result: null, matchType: 'item_rule' };
            }
            
            const wovenKeywords = [
                '„Ç∏„É£„Éº„Ç∏„Éï„É©„Éé', 'ÔΩºÔæûÔΩ¨ÔΩ∞ÔΩºÔæûÔæåÔæóÔæâ',
                'denim', '„Éá„Éã„É†', 'ÔæÉÔæûÔæÜÔæë',
                '„Ç∑„É£„ÉÑ', 'ÔΩºÔΩ¨ÔæÇ', 'shirt',
                'twill', '„ÉÑ„Ç§„É´', 'ÔæÇÔΩ≤Ôæô',
                'gabardine', '„ÇÆ„É£„Éê„Ç∏„É≥', 'ÔΩ∑ÔæûÔΩ¨ÔæäÔæûÔΩºÔæûÔæù',
                'taffeta', '„Çø„Éï„Çø', 'ÔæÄÔæåÔæÄ',
                '„Éï„É©„É≥„Éç„É´', 'ÔæåÔæóÔæùÔæàÔæô'
            ];
            
            const knitKeywords = [
                '„Éã„ÉÉ„Éà', '„Å´„Å£„Å®', 'ÔæÜÔΩØÔæÑ',
                'sweater', '„Çπ„Ç¶„Çß„ÉÉ„Éà', 'ÔΩΩÔΩ≥ÔΩ™ÔΩØÔæÑ',
                'cardigan', '„Ç´„Éº„Éá„Ç£„Ç¨„É≥', 'ÔΩ∂ÔΩ∞ÔæÉÔæûÔΩ®ÔΩ∂ÔæûÔæù',
                '„Ç´„ÉÉ„Éà„ÇΩ„Éº', 'ÔΩ∂ÔΩØÔæÑÔΩøÔΩ∞',
                'Á∑®„Åø'
            ];
            
            for (const keyword of wovenKeywords) {
                if (combined.includes(keyword.toLowerCase())) {
                    console.log(`  ‚Üí keyword: Woven (matched: ${keyword})`);
                    return { result: 'Woven', matchType: 'keyword' };
                }
            }
            
            for (const keyword of knitKeywords) {
                if (combined.includes(keyword.toLowerCase())) {
                    console.log(`  ‚Üí keyword: Knit (matched: ${keyword})`);
                    return { result: 'Knit', matchType: 'keyword' };
                }
            }
            
            const defaults = {
                '„Éñ„É´„Çæ„É≥„Éª„Ç∏„É£„Ç±„ÉÉ„Éà': 'Woven',
                '„Ç≥„Éº„Éà': 'Woven',
                '„Çπ„Ç´„Éº„Éà': 'Woven',
                '„ÉØ„É≥„Éî„Éº„Çπ': 'Woven',
                '„Éë„É≥„ÉÑ': 'Woven'
            };
            
            const defaultValue = defaults[item] || 'Woven';
            console.log(`  ‚Üí default: ${defaultValue}`);
            return { result: defaultValue, matchType: 'default' };
        }
        
        function determineHSCode(row) {
            const item = row['„Ç¢„Ç§„ÉÜ„É†'] || '';
            const productName = row['ÂìÅÂêç'] || '';
            const gender = (row['ÊÄßÂà•'] || '') === '„É°„É≥„Ç∫' ? 'M' : 'W';
            const material = normalizeMaterial(row['Á¥†Êùê1']);
            
            console.log(`\n=== HS„Ç≥„Éº„ÉâÂà§ÂÆö ===`);
            console.log(`ÂìÅÁï™: ${row['ÂìÅÁï™']}, „Ç¢„Ç§„ÉÜ„É†: ${item}`);
            
            const categoryEN = translateCategory(item);
            let description = categoryEN;
            let descMatched = true;
            
            if (item === '„Ç∞„ÉÉ„Ç∫') {
                const normalized = toFullWidth(productName);
                console.log(`„Ç∞„ÉÉ„Ç∫Âà§ÂÆö: ${productName} ‚Üí ${normalized}`);
                
                for (const [keyword, translation] of Object.entries(GOODS_KEYWORDS)) {
                    if (normalized.includes(keyword)) {
                        description = translation;
                        console.log(`  ‚úì Matched: ${keyword} ‚Üí ${translation}`);
                        break;
                    }
                }
                if (description === 'Goods') {
                    descMatched = false;
                    console.log(`  ‚úó No match ‚Üí Goods`);
                }
            }
            
            const knitWovenResult = determineKnitWoven(item, productName);
            const knitWoven = knitWovenResult.result;
            const matchType = knitWovenResult.matchType;
            
            let hsCode = 'N/A';
            
            if (item === '„Ç∞„ÉÉ„Ç∫') {
                hsCode = HS_CODE_RULES['Goods'] || '42029260';
            } else if (knitWoven) {
                const key = `${categoryEN}-${knitWoven}-${gender}-${material}`;
                hsCode = HS_CODE_RULES[key];
                
                if (!hsCode) {
                    const keyNoMaterial = `${categoryEN}-${knitWoven}-${gender}`;
                    for (const ruleKey of Object.keys(HS_CODE_RULES)) {
                        if (ruleKey.startsWith(keyNoMaterial)) {
                            hsCode = HS_CODE_RULES[ruleKey];
                            break;
                        }
                    }
                }
                
                console.log(`HS„Ç≥„Éº„ÉâÊ§úÁ¥¢: ${key} ‚Üí ${hsCode || 'N/A'}`);
            }
            
            return {
                description: description,
                descMatched: descMatched,
                hsCode: hsCode || 'N/A',
                knitWoven: knitWoven,
                matchType: matchType
            };
        }
        
        function getFirst8Digits(styleNo) {
            if (!styleNo) return '';
            const cleanStyleNo = styleNo.toString().trim();
            return cleanStyleNo.substring(0, 8);
        }
        
        function processFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                alert('Excel„Éï„Ç°„Ç§„É´ (.xlsx „Åæ„Åü„ÅØ .xls) „Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\nPlease upload an Excel file (.xlsx or .xls)');
                return;
            }
            
            showLoading();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    processExcelData(jsonData);
                    
                    hideLoading();
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('controlSection').classList.add('active');
                    document.getElementById('dataSection').classList.add('active');
                    document.getElementById('noCommercialSection').classList.add('active');
                    document.getElementById('nonCommercialSection').classList.add('active');
                    
                    // ÂàùÊúüÂåñ: Container 2 & 3„Å´1Ë°åËøΩÂä†
                    addNoCommercialRow();
                    addNonCommercialRow();
                    
                    updateGrandTotal();
                } catch (error) {
                    hideLoading();
                    alert('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü / Failed to read file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processExcelData(jsonData) {
            console.log('=== Processing Excel Data ===');
            
            const validRows = jsonData.filter(row => {
                const hasStyleNo = row['ÂìÅÁï™'] && row['ÂìÅÁï™'].toString().trim() !== '';
                const hasItemName = row['ÂìÅÂêç'] && row['ÂìÅÂêç'].toString().trim() !== '';
                const hasItemCategory = row['„Ç¢„Ç§„ÉÜ„É†'] && row['„Ç¢„Ç§„ÉÜ„É†'].toString().trim() !== '';
                return hasStyleNo && hasItemName && hasItemCategory;
            });
            
            console.log('Valid rows:', validRows.length);
            
            const grouped = {};
            const hsDebug = { item_rule: 0, keyword: 0, default: 0, defaultItems: [] };
            
            validRows.forEach((row, index) => {
                const styleNo = row['ÂìÅÁï™'] || '';
                const itemCategory = row['„Ç¢„Ç§„ÉÜ„É†'] || '';
                const itemName = row['ÂìÅÂêç'] || '';
                const quantity = row['Êï∞Èáè'] || 0;
                const originalPrice = row['‰∏ä‰ª£'] || 0;
                const country = row['ÂéüÁî£ÂõΩ'] || 'CN';
                
                const first8 = getFirst8Digits(styleNo);
                
                console.log(`\n--- Row ${index + 1} ---`);
                console.log('Item Code:', first8);
                console.log('Item Name:', itemName);
                console.log('Quantity:', quantity);
                
                if (!first8) {
                    console.log('‚äó Skipped: No item code');
                    return;
                }
                
                if (grouped[first8]) {
                    grouped[first8].units += quantity;
                    console.log(`‚úì Added to existing group. New total: ${grouped[first8].units}`);
                } else {
                    const hsResult = determineHSCode(row);
                    
                    grouped[first8] = {
                        itemCode: first8,
                        units: quantity,
                        weightPerUnit: getWeightByCategory(itemCategory),
                        measure: 'PCS',
                        description: hsResult.description,
                        matched: hsResult.descMatched,
                        hsCode: hsResult.hsCode,
                        country: country,
                        unitValue: calculatePrice(originalPrice),
                        totalValue: 0,
                        matchType: hsResult.matchType,
                        rawData: row
                    };
                    
                    hsDebug[hsResult.matchType]++;
                    if (hsResult.matchType === 'default') {
                        hsDebug.defaultItems.push({
                            code: first8,
                            name: itemName,
                            item: itemCategory
                        });
                    }
                    
                    console.log(`‚úì Created new group`);
                }
            });
            
            productData = Object.values(grouped);
            
            console.log('\n=== Final Grouped Data ===');
            console.log('Total unique items:', productData.length);
            
            productData.forEach(item => {
                item.totalValue = item.units * item.unitValue;
                item.weight = item.weightPerUnit * item.units;
                console.log(`${item.itemCode}: ${item.description} (${item.units}) ‚Üí HS„Ç≥„Éº„Éâ: ${item.hsCode} [${item.matchType}]`);
            });
            
            displayDebugSummary(hsDebug);
            renderDataTable();
        }
        
        function displayDebugSummary(hsDebug) {
            const summary = document.getElementById('debugSummary');
            summary.style.display = 'block';
            
            let html = '<h4>üîç Knit/WovenÂà§ÂÆöÁµêÊûú</h4>';
            html += `<div>‚úì Á¢∫ÂÆü (item_rule): ${hsDebug.item_rule}‰ª∂</div>`;
            html += `<div>‚ö† „Ç≠„Éº„ÉØ„Éº„Éâ (keyword): ${hsDebug.keyword}‰ª∂</div>`;
            html += `<div>‚úó „Éá„Éï„Ç©„É´„Éà (default): ${hsDebug.default}‰ª∂</div>`;
            
            if (hsDebug.defaultItems.length > 0) {
                html += '<div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #475569;">„Éá„Éï„Ç©„É´„ÉàÈÅ©Áî®„Åï„Çå„ÅüÂïÜÂìÅ:</div>';
                hsDebug.defaultItems.forEach(item => {
                    html += `<div style="padding-left: 1rem;">‚Ä¢ ${item.code}: ${item.name} (${item.item})</div>`;
                });
            }
            
            summary.innerHTML = html;
        }
        
        function renderDataTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            let totalUnits = 0;
            
            productData.forEach((item, index) => {
                totalUnits += item.units;
                
                const row = tbody.insertRow();
                
                if (item.matchType === 'default') {
                    row.classList.add('hs-match-default');
                }
                
                row.innerHTML = `
                    <td><input type="text" value="${item.itemCode}" onchange="updateRow(${index}, 'itemCode', this.value)"></td>
                    <td><input type="number" value="${item.units}" onchange="updateRow(${index}, 'units', this.value)" min="0" step="1"></td>
                    <td><input type="number" value="${item.weight.toFixed(2)}" onchange="updateRow(${index}, 'weight', this.value)" min="0" step="0.1"></td>
                    <td>
                        <select onchange="updateRow(${index}, 'measure', this.value)">
                            <option value="PCS" ${item.measure === 'PCS' ? 'selected' : ''}>PCS</option>
                            <option value="SET" ${item.measure === 'SET' ? 'selected' : ''}>SET</option>
                            <option value="DOZ" ${item.measure === 'DOZ' ? 'selected' : ''}>DOZ</option>
                        </select>
                    </td>
                    <td><input type="text" value="${item.description}" onchange="updateRow(${index}, 'description', this.value)" class="${!item.matched ? 'needs-review' : ''}"></td>
                    <td><input type="text" value="${item.hsCode}" onchange="updateRow(${index}, 'hsCode', this.value)" placeholder="HS Code"></td>
                    <td><input type="text" value="${item.country}" onchange="updateRow(${index}, 'country', this.value)"></td>
                    <td><input type="text" class="align-right" value="${item.unitValue.toLocaleString()}" onchange="updateRow(${index}, 'unitValue', this.value.replace(/,/g, ''))"></td>
                    <td><input type="text" class="align-right" value="${item.totalValue.toLocaleString()}" readonly></td>
                `;
            });
            
            document.getElementById('totalItemsCount1').textContent = totalUnits;
            updateGrandTotal();
            lucide.createIcons();
        }
        
        function updateRow(index, field, value) {
            if (field === 'units' || field === 'weight') {
                productData[index][field] = parseFloat(value) || 0;
            } else if (field === 'unitValue') {
                productData[index][field] = parseFloat(value) || 0;
            } else {
                productData[index][field] = value;
            }
            
            if (field === 'units' || field === 'unitValue') {
                productData[index].totalValue = productData[index].units * productData[index].unitValue;
                renderDataTable();
            }
        }
        
        // Container 2: No Commercial Value Items
        function addNoCommercialRow() {
            const tbody = document.getElementById('noCommercialBody');
            const index = noCommercialData.length;
            
            noCommercialData.push({
                itemCode: '',
                units: 0,
                weight: 0,
                measure: 'PCS',
                description: '',
                hsCode: '',
                country: 'CN',
                unitValue: 0,
                totalValue: 0
            });
            
            const row = tbody.insertRow();
            
            const presetOptions = Object.keys(presets).map(name => 
                `<option value="${name}">${name}</option>`
            ).join('');
            
            row.innerHTML = `
                <td><input type="text" value="" onchange="updateNoCommercial(${index}, 'itemCode', this.value)"></td>
                <td><input type="number" value="0" onchange="updateNoCommercial(${index}, 'units', this.value)" min="0" step="1"></td>
                <td><input type="number" value="0" onchange="updateNoCommercial(${index}, 'weight', this.value)" min="0" step="0.1"></td>
                <td>
                    <select onchange="updateNoCommercial(${index}, 'measure', this.value)">
                        <option value="PCS">PCS</option>
                        <option value="SET">SET</option>
                        <option value="DOZ">DOZ</option>
                    </select>
                </td>
                <td>
                    <select onchange="selectPreset(${index}, this.value)">
                        <option value="">-- Select Preset --</option>
                        ${presetOptions}
                    </select>
                </td>
                <td><input type="text" value="" onchange="updateNoCommercial(${index}, 'hsCode', this.value)" readonly></td>
                <td><input type="text" value="CN" onchange="updateNoCommercial(${index}, 'country', this.value)"></td>
                <td><input type="text" class="align-right" value="0" onchange="updateNoCommercial(${index}, 'unitValue', this.value.replace(/,/g, ''))" readonly></td>
                <td><input type="text" class="align-right" value="0" readonly></td>
            `;
            
            lucide.createIcons();
        }
        
        function selectPreset(index, presetName) {
            if (!presetName || !presets[presetName]) return;
            
            const preset = presets[presetName];
            noCommercialData[index].description = presetName;
            noCommercialData[index].hsCode = preset.hs_code;
            noCommercialData[index].unitValue = preset.unit_value;
            
            renderNoCommercialTable();
        }
        
        function updateNoCommercial(index, field, value) {
            if (field === 'units' || field === 'weight' || field === 'unitValue') {
                noCommercialData[index][field] = parseFloat(value) || 0;
            } else {
                noCommercialData[index][field] = value;
            }
            
            if (field === 'units' || field === 'unitValue') {
                noCommercialData[index].totalValue = noCommercialData[index].units * noCommercialData[index].unitValue;
                renderNoCommercialTable();
            }
        }
        
        function renderNoCommercialTable() {
            const tbody = document.getElementById('noCommercialBody');
            tbody.innerHTML = '';
            
            let totalUnits = 0;
            
            noCommercialData.forEach((item, index) => {
                totalUnits += item.units;
                
                const row = tbody.insertRow();
                
                const presetOptions = Object.keys(presets).map(name => 
                    `<option value="${name}" ${item.description === name ? 'selected' : ''}>${name}</option>`
                ).join('');
                
                row.innerHTML = `
                    <td><input type="text" value="${item.itemCode}" onchange="updateNoCommercial(${index}, 'itemCode', this.value)"></td>
                    <td><input type="number" value="${item.units}" onchange="updateNoCommercial(${index}, 'units', this.value)" min="0" step="1"></td>
                    <td><input type="number" value="${item.weight.toFixed(2)}" onchange="updateNoCommercial(${index}, 'weight', this.value)" min="0" step="0.1"></td>
                    <td>
                        <select onchange="updateNoCommercial(${index}, 'measure', this.value)">
                            <option value="PCS" ${item.measure === 'PCS' ? 'selected' : ''}>PCS</option>
                            <option value="SET" ${item.measure === 'SET' ? 'selected' : ''}>SET</option>
                            <option value="DOZ" ${item.measure === 'DOZ' ? 'selected' : ''}>DOZ</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="selectPreset(${index}, this.value)">
                            <option value="">-- Select Preset --</option>
                            ${presetOptions}
                        </select>
                    </td>
                    <td><input type="text" value="${item.hsCode}" onchange="updateNoCommercial(${index}, 'hsCode', this.value)" readonly></td>
                    <td><input type="text" value="${item.country}" onchange="updateNoCommercial(${index}, 'country', this.value)"></td>
                    <td><input type="text" class="align-right" value="${item.unitValue.toLocaleString()}" onchange="updateNoCommercial(${index}, 'unitValue', this.value.replace(/,/g, ''))" readonly></td>
                    <td><input type="text" class="align-right" value="${item.totalValue.toLocaleString()}" readonly></td>
                `;
            });
            
            document.getElementById('totalItemsCount2').textContent = totalUnits;
            updateGrandTotal();
            lucide.createIcons();
        }
        
        // Container 3: Non-Commercial Items
        function addNonCommercialRow() {
            const tbody = document.getElementById('nonCommercialBody');
            const index = nonCommercialData.length;
            
            nonCommercialData.push({
                description: '',
                quantity: 0
            });
            
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" value="" onchange="updateNonCommercial(${index}, 'description', this.value)" placeholder="Enter description"></td>
                <td><input type="number" value="0" onchange="updateNonCommercial(${index}, 'quantity', this.value)" min="0" step="1"></td>
            `;
        }
        
        function updateNonCommercial(index, field, value) {
            if (field === 'quantity') {
                nonCommercialData[index][field] = parseFloat(value) || 0;
            } else {
                nonCommercialData[index][field] = value;
            }
            
            if (field === 'quantity') {
                renderNonCommercialTable();
            }
        }
        
        function renderNonCommercialTable() {
            const tbody = document.getElementById('nonCommercialBody');
            tbody.innerHTML = '';
            
            let totalUnits = 0;
            
            nonCommercialData.forEach((item, index) => {
                totalUnits += item.quantity;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${item.description}" onchange="updateNonCommercial(${index}, 'description', this.value)" placeholder="Enter description"></td>
                    <td><input type="number" value="${item.quantity}" onchange="updateNonCommercial(${index}, 'quantity', this.value)" min="0" step="1"></td>
                `;
            });
            
            document.getElementById('totalItemsCount3').textContent = totalUnits;
            updateGrandTotal();
        }
        
        // Á∑èÂêàË®àÁÆó
        function updateGrandTotal() {
            // ÂêàË®àÁÇπÊï∞
            const total1 = productData.reduce((sum, item) => sum + item.units, 0);
            const total2 = noCommercialData.reduce((sum, item) => sum + item.units, 0);
            const total3 = nonCommercialData.reduce((sum, item) => sum + item.quantity, 0);
            const grandTotal = total1 + total2 + total3;
            
            // Ë´ãÊ±ÇÈáëÈ°çÔºàContainer 1 + 2„ÅÆ„ÅøÔºâ
            const amount1 = productData.reduce((sum, item) => sum + item.totalValue, 0);
            const amount2 = noCommercialData.reduce((sum, item) => sum + item.totalValue, 0);
            const grandAmount = amount1 + amount2;
            
            document.getElementById('grandTotalItems').textContent = grandTotal;
            document.getElementById('grandTotalAmount').textContent = `JPY ${grandAmount.toLocaleString()}`;
        }
        
        function generateInvoice() {
            console.log('=== Invoice Data ===');
            console.log('Product Data:', productData);
            console.log('No Commercial Value Items:', noCommercialData);
            console.log('Non-Commercial Items:', nonCommercialData);
            
            alert('„Ç§„É≥„Éú„Ç§„ÇπÁîüÊàêÊ©üËÉΩ„ÅØÊ¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅßÂÆüË£Ö„Åó„Åæ„Åô\nInvoice generation will be implemented in the next step');
        }
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        });
        
        const dropZone = document.getElementById('dropZone');
        
        dropZone.addEventListener('click', function(e) {
            if (e.target.closest('.file-input-wrapper')) return;
            document.getElementById('fileInput').click();
        });
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, function(e) {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, function() {
                this.classList.add('drag-over');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, function() {
                this.classList.remove('drag-over');
            }, false);
        });
        
        dropZone.addEventListener('drop', function(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) processFile(files[0]);
        }, false);
        
        function openPresetModal() {
            document.getElementById('presetModal').classList.add('active');
            renderPresets();
        }
        
        function closePresetModal() {
            document.getElementById('presetModal').classList.remove('active');
        }
        
        function renderPresets() {
            const container = document.getElementById('presetList');
            container.innerHTML = '';
            
            for (const [name, data] of Object.entries(presets)) {
                const item = document.createElement('div');
                item.className = 'preset-item';
                item.innerHTML = `
                    <div>
                        <label>Description</label>
                        <input type="text" value="${name}" data-field="name" data-original="${name}">
                    </div>
                    <div>
                        <label>HS Code</label>
                        <input type="text" value="${data.hs_code}" data-field="hs_code" data-name="${name}">
                    </div>
                    <div>
                        <label>Unit Value (JPY)</label>
                        <input type="number" value="${data.unit_value}" data-field="unit_value" data-name="${name}">
                    </div>
                    <button class="btn-delete" onclick="deletePreset('${name}')">
                        <i data-lucide="trash-2" size="18"></i>
                    </button>
                `;
                container.appendChild(item);
            }
            
            lucide.createIcons();
        }
        
        function addNewPreset() {
            const newName = `New Item ${Object.keys(presets).length + 1}`;
            presets[newName] = { hs_code: "", unit_value: 0 };
            renderPresets();
        }
        
        function deletePreset(name) {
            if (confirm(`Delete "${name}"?`)) {
                delete presets[name];
                renderPresets();
            }
        }
        
        function savePresets() {
            const items = document.querySelectorAll('.preset-item');
            const newPresets = {};
            
            items.forEach(item => {
                const nameInput = item.querySelector('[data-field="name"]');
                const hsInput = item.querySelector('[data-field="hs_code"]');
                const valueInput = item.querySelector('[data-field="unit_value"]');
                
                const name = nameInput.value.trim();
                if (name) {
                    newPresets[name] = {
                        hs_code: hsInput.value.trim(),
                        unit_value: parseFloat(valueInput.value) || 0
                    };
                }
            });
            
            presets = newPresets;
            localStorage.setItem('invoicePresets', JSON.stringify(presets));
            alert('‰øùÂ≠ò„Åó„Åæ„Åó„Åü / Presets saved successfully!');
            closePresetModal();
        }
        
        document.getElementById('presetModal').addEventListener('click', function(e) {
            if (e.target === this) closePresetModal();
        });
    </script>
</body>
</html>
