<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: #f5f7fa; }
        
        .header {
            background-color: #1c2940;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: white;
            color: #1c2940;
        }
        
        .btn-primary:hover {
            background-color: #e8eaf0;
        }
        
        .container {
            max-width: 98%;
            margin: 1rem auto;
            padding: 0 0.5rem;
        }
        
        .upload-section {
            background: white;
            padding: 3rem 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-family: 'Montserrat', sans-serif;
            color: #1c2940;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }
        
        .section-subtitle {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        
        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 4rem 2rem;
            background-color: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drop-zone:hover {
            border-color: #64748b;
            background-color: #f1f5f9;
        }
        
        .drop-zone.drag-over {
            border-color: #1c2940;
            background-color: #e0e7ff;
            border-width: 3px;
        }
        
        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.25rem;
            pointer-events: none;
        }
        
        .drop-zone-icon { color: #94a3b8; }
        .drop-zone.drag-over .drop-zone-icon { color: #1c2940; }
        
        .drop-zone-text {
            color: #64748b;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .drop-zone.drag-over .drop-zone-text { color: #1c2940; }
        
        .or-text {
            color: #94a3b8;
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }
        
        .file-input-wrapper { position: relative; display: inline-block; }
        .file-input-wrapper input[type="file"] { display: none; }
        
        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 2rem;
            background-color: #1c2940;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.2s;
            pointer-events: auto;
        }
        
        .file-input-label:hover {
            background-color: #2a3d5f;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(28, 41, 64, 0.3);
        }
        
        .format-text {
            color: #94a3b8;
            font-size: 0.85rem;
            margin-top: 1rem;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active { display: flex; }
        
        .loading-content {
            background: white;
            padding: 2rem 3rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 1rem;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #1c2940;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #1c2940;
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .loading-subtext {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .control-section {
            display: none;
            background: linear-gradient(135deg, #5a6c8a 0%, #6b7a94 100%);
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 2rem;
            color: white;
        }
        
        .control-section.active { display: flex; }
        
        .control-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 2rem;
        }
        
        .total-summary {
            display: flex;
            align-items: center;
            gap: 3rem;
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
        }
        
        .summary-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
        }

        .invoice-number-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .invoice-number-input span {
            font-size: 1.2rem;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
        }

        .invoice-number-input input {
            padding: 0.5rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            color: #1c2940;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            width: 80px;
            text-align: center;
        }

        .invoice-number-input input:focus {
            outline: none;
            border-color: white;
            background: white;
        }

        .invoice-number-input input.serial {
            width: 60px;
        }

        .invoice-number-input input.serial:not(:focus):invalid,
        .invoice-number-input input.serial:not(:focus):placeholder-shown {
            background-color: #ffc9c9;
        }
        
        .data-section {
            display: none;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .data-section.active { display: block; }
        
        .data-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .data-section-title { flex: 1; }
        
        .data-section-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .total-items {
            font-size: 0.9rem;
            color: #1c2940;
            font-weight: 600;
            padding: 0.5rem 1rem;
            background-color: #f3f4f6;
            border-radius: 6px;
        }
        
        .data-table-wrapper {
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            table-layout: fixed;
        }
        
        .data-table th {
            background-color: #1c2940;
            color: white;
            padding: 0.6rem 0.4rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .data-table th:nth-child(1) { width: 7%; }
        .data-table th:nth-child(2) { width: 6%; }
        .data-table th:nth-child(3) { width: 7%; }
        .data-table th:nth-child(4) { width: 8%; }
        .data-table th:nth-child(5) { width: 17%; }
        .data-table th:nth-child(6) { width: 12%; }
        .data-table th:nth-child(7) { width: 8%; }
        .data-table th:nth-child(8) { width: 12%; }
        .data-table th:nth-child(9) { width: 14%; }
        .data-table th:nth-child(10) { width: 5%; }
        
        .data-table td {
            padding: 0.6rem 0.4rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table tbody tr:hover {
            background-color: #f9fafb;
        }
        
        .data-table input,
        .data-table select {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }
        
        .data-table input:focus,
        .data-table select:focus {
            outline: none;
            border-color: #1c2940;
        }
        
        .data-table input[readonly] {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }

        .data-table input.editable-readonly {
            background-color: #f9fafb;
            cursor: text;
        }

        .data-table input.editable-readonly:focus {
            background-color: white;
        }
        
        .data-table input.align-right {
            text-align: right;
        }
        
        .needs-review {
            background-color: #fef3c7 !important;
            border: 2px solid #f59e0b !important;
        }
        
        .hs-match-default {
            background-color: #f8d7da !important;
        }
        
        .btn-add-row {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }
        
        .btn-add-row:hover {
            background-color: #059669;
        }
        
        .btn-generate {
            padding: 0.75rem 2rem;
            background-color: white;
            color: #5a6c8a;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-generate:hover {
            background-color: rgba(255,255,255,0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
        
        .nc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .nc-table th {
            background-color: #1c2940;
            color: white;
            padding: 0.6rem 0.8rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .nc-table th:nth-child(1) { width: 65%; }
        .nc-table th:nth-child(2) { width: 25%; }
        .nc-table th:nth-child(3) { width: 10%; }
        
        .nc-table td {
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .nc-table input {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-family: 'Montserrat', sans-serif;
            color: #1c2940;
            font-size: 1.25rem;
        }
        
        .btn-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: #6b7280;
            transition: color 0.2s;
        }
        
        .btn-close:hover { color: #1c2940; }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .preset-item {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr auto;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            align-items: center;
            background-color: #f9fafb;
        }
        
        .preset-item input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }
        
        .preset-item label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .btn-delete {
            background-color: transparent;
            color: #ef4444;
            border: 1px solid #fecaca;
            padding: 0.35rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-delete:hover {
            background-color: #fee2e2;
            color: #dc2626;
            border-color: #fca5a5;
        }
        
        .btn-add {
            width: 100%;
            padding: 0.75rem;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 1rem;
            transition: background-color 0.2s;
        }
        
        .btn-add:hover { background-color: #059669; }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover { background-color: #d1d5db; }
        
        .btn-save {
            background-color: #1c2940;
            color: white;
        }
        
        .btn-save:hover { background-color: #2a3d5f; }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
        }

        .form-section h4 {
            font-family: 'Montserrat', sans-serif;
            color: #1c2940;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            padding: 0.625rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1c2940;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-title">
            <i data-lucide="package" size="28"></i>
            Invoice Generator
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openGeneralInfoModal()">
                <i data-lucide="file-text" size="18"></i>
                General Info
            </button>
            <button class="btn btn-primary" onclick="openPresetModal()">
                <i data-lucide="settings" size="18"></i>
                Manage Presets
            </button>
        </div>
    </header>
    
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">処理中... / Processing...</div>
            <div class="loading-subtext">ファイルを読み込んでいます / Reading file</div>
        </div>
    </div>
    
    <div class="container">
        <div id="uploadSection" class="upload-section">
            <h2 class="section-title">商品明細のエクセルファイルをアップロード</h2>
            <p class="section-subtitle">Upload Product List Excel File</p>
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-content">
                    <div class="drop-zone-icon">
                        <i data-lucide="file-spreadsheet" size="56"></i>
                    </div>
                    <p class="drop-zone-text">ファイルをドラッグ&ドロップ / Drag & Drop File</p>
                    <p class="or-text">または / or</p>
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" accept=".xlsx,.xls">
                        <label for="fileInput" class="file-input-label">
                            <i data-lucide="upload" size="20"></i>
                            Choose File
                        </label>
                    </div>
                    <p class="format-text">.xlsx または .xls 形式 / .xlsx or .xls format</p>
                </div>
            </div>
        </div>
        
        <div id="controlSection" class="control-section">
            <div class="control-content">
                <div class="total-summary">
                    <div class="summary-item">
                        <span class="summary-label">Invoice No.</span>
                        <div class="invoice-number-input">
                            <span>RPM-EC-</span>
                            <input type="text" id="invoiceYYMM" maxlength="4" placeholder="YYMM">
                            <span>-</span>
                            <input type="text" id="invoiceSerial" class="serial" maxlength="3" required>
                        </div>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">全体合計点数 / Total Items</span>
                        <span class="summary-value" id="grandTotalItems">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">請求金額 / Invoice Amount</span>
                        <span class="summary-value" id="grandTotalAmount">JPY 0</span>
                    </div>
                </div>
                <button class="btn-generate" onclick="generateInvoice()">
                    <i data-lucide="file-text" size="20"></i>
                    インボイスを生成
                </button>
            </div>
        </div>
        
        <div id="dataSection" class="data-section">
            <div class="data-section-header">
                <div class="data-section-title">
                    <h2 class="section-title">商品明細リスト / Product Details List</h2>
                    <p class="section-subtitle">編集可能です / Editable</p>
                </div>
                <div class="data-section-info">
                    <div class="total-items">
                        合計点数 / Total: <span id="totalItemsCount1">0</span>
                    </div>
                </div>
            </div>
            
            <div class="data-table-wrapper">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>No. of Units</th>
                            <th>Net Weight (KG)</th>
                            <th>Unit of Measure</th>
                            <th>Description of Goods</th>
                            <th>Harmonized Tariff Number</th>
                            <th>Country/Terr. of MFR</th>
                            <th>Unit Value (JPY)</th>
                            <th>Total Value (JPY)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <div id="noCommercialSection" class="data-section">
            <div class="data-section-header">
                <div class="data-section-title">
                    <h2 class="section-title">販促物・有償提供品 / Promotional Items (Commercial Value)</h2>
                    <p class="section-subtitle">カタログ・販促物など / Catalogs, Promotional Materials</p>
                </div>
                <div class="data-section-info">
                    <div class="total-items">
                        合計点数 / Total: <span id="totalItemsCount2">0</span>
                    </div>
                </div>
            </div>
            
            <div class="data-table-wrapper">
                <table class="data-table" id="noCommercialTable">
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>No. of Units</th>
                            <th>Net Weight (KG)</th>
                            <th>Unit of Measure</th>
                            <th>Description of Goods</th>
                            <th>Harmonized Tariff Number</th>
                            <th>Country/Terr. of MFR</th>
                            <th>Unit Value (JPY)</th>
                            <th>Total Value (JPY)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="noCommercialBody"></tbody>
                </table>
            </div>
            
            <button class="btn-add-row" onclick="addNoCommercialRow()">
                <i data-lucide="plus" size="16"></i>
                行を追加 / Add Row
            </button>
        </div>
        
        <div id="nonCommercialSection" class="data-section">
            <div class="data-section-header">
                <div class="data-section-title">
                    <h2 class="section-title">無償提供品 / Non-Commercial Value Items</h2>
                    <p class="section-subtitle">無償サンプル・資料など / Free Samples, Documents (金額に含まれません / Not included in invoice amount)</p>
                </div>
            </div>
            
            <div class="data-table-wrapper">
                <table class="nc-table" id="nonCommercialTable">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="nonCommercialBody"></tbody>
                </table>
            </div>
            
            <button class="btn-add-row" onclick="addNonCommercialRow()">
                <i data-lucide="plus" size="16"></i>
                行を追加 / Add Row
            </button>
        </div>
    </div>
    
    <div id="generalInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>General Information / 基本情報</h3>
                <button class="btn-close" onclick="closeGeneralInfoModal()">
                    <i data-lucide="x" size="24"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4>EXPORTER / 輸出者</h4>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Company Name / 会社名</label>
                            <input type="text" id="exporterName" value="45RPM STUDIO Co.,Ltd.">
                        </div>
                        <div class="form-group full-width">
                            <label>Address / 住所</label>
                            <textarea id="exporterAddress">7-2-1 MINAMIAOYAMA, MINATO-KU, TOKYO 107-0062 JAPAN</textarea>
                        </div>
                        <div class="form-group">
                            <label>TEL</label>
                            <input type="text" id="exporterTel" value="81-3-3498-1345">
                        </div>
                        <div class="form-group">
                            <label>FAX</label>
                            <input type="text" id="exporterFax" value="81-3-3486-7145">
                        </div>
                        <div class="form-group">
                            <label>卸値パーセンテージ / Wholesale Percentage (%)</label>
                            <input type="number" id="pricePercentage" value="42" min="0" max="100" step="1">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h4>CONSIGNEE / 荷受人（実際の配送先）</h4>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Company Name / 会社名</label>
                            <input type="text" id="consigneeName" value="FENIX LOGISTIC SERVICES LIMITED">
                        </div>
                        <div class="form-group full-width">
                            <label>Address / 住所</label>
                            <textarea id="consigneeAddress">4/F, Chuan Kei Factory Building, 15-23 Kin Hong Street, Kwai Chung, N.T., Hong Kong</textarea>
                        </div>
                        <div class="form-group">
                            <label>Contact Person / 担当者</label>
                            <input type="text" id="consigneeContact" value="Kawa (Mr.) / Kit (Mr.)">
                        </div>
                        <div class="form-group">
                            <label>TEL</label>
                            <input type="text" id="consigneeTel" value="2127-4660">
                        </div>
                        <div class="form-group full-width">
                            <label>Email</label>
                            <input type="email" id="consigneeEmail" value="fls.wh@fls.com.hk">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h4>SOLD TO / IMPORTER / 買主・輸入者</h4>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Company Name / 会社名</label>
                            <input type="text" id="importerName" value="Heritage R LTD.">
                        </div>
                        <div class="form-group full-width">
                            <label>Address / 住所</label>
                            <textarea id="importerAddress">36/F, TOWER 2, THE GATEWAY, 25 CANTON ROAD, TSIM SHA TSUI, KOWLOON, HONG KONG</textarea>
                        </div>
                        <div class="form-group">
                            <label>TEL</label>
                            <input type="text" id="importerTel" value="852-2956-3266">
                        </div>
                        <div class="form-group">
                            <label>FAX</label>
                            <input type="text" id="importerFax" value="852-2956-1230">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGeneralInfoModal()">Cancel</button>
                <button class="btn btn-save" onclick="saveGeneralInfo()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="presetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Preset Goods</h3>
                <button class="btn-close" onclick="closePresetModal()">
                    <i data-lucide="x" size="24"></i>
                </button>
            </div>
            <div class="modal-body" id="presetList"></div>
            <div style="padding: 0 1.5rem;">
                <button class="btn-add" onclick="addNewPreset()">
                    <i data-lucide="plus" size="18"></i> Add New Preset
                </button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePresetModal()">Cancel</button>
                <button class="btn btn-save" onclick="savePresets()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        lucide.createIcons();
        
        let productData = [];
        let noCommercialData = [];
        let nonCommercialData = [];
        let uploadDate = new Date();
        
        const ITEM_WEIGHT_MAP = {
            "ブルゾン・ジャケット": 0.8, "コート": 1.2, "シャツ": 0.3,
            "スカート": 0.4, "ワンピース": 0.5, "パンツ": 0.5,
            "カットソー": 0.3, "ニット": 0.4, "グッズ": 0.2
        };
        
        const ITEM_CATEGORY_TRANSLATION = {
            "ブルゾン・ジャケット": "Jacket", "コート": "Coat", "シャツ": "Shirt",
            "スカート": "Skirt", "ワンピース": "Dress", "パンツ": "Pants",
            "カットソー": "Knit Top", "ニット": "Knit Top", "グッズ": "Goods"
        };
        
        const MATERIAL_BUCKETS = {
            'ウール': 'Wool', '毛': 'Wool', 'アルパカ': 'Wool', 'WOOL': 'Wool',
            'カシミヤ': 'Cashmere', 'カシミア': 'Cashmere', 'CASHMERE': 'Cashmere',
            'コットン': 'Cotton', '綿': 'Cotton', 'COTTON': 'Cotton',
            'ポリエステル': 'Synthetic', 'ナイロン': 'Synthetic', 'アクリル': 'Synthetic',
            'レーヨン': 'Artificial', 'RAYON': 'Artificial', 'VISCOSE': 'Artificial',
            'シルク': 'Silk', '絹': 'Silk', 'SILK': 'Silk'
        };
        
        const HS_CODE_RULES = {
            "Jacket-Knit-M-Wool": "61033100", "Jacket-Knit-M-Cotton": "61033200",
            "Jacket-Knit-W-Wool": "61043100", "Jacket-Knit-W-Cotton": "61043200",
            "Jacket-Woven-M-Wool": "62033100", "Jacket-Woven-M-Cotton": "62033290",
            "Jacket-Woven-W-Wool": "62043100", "Jacket-Woven-W-Cotton": "62043290",
            "Coat-Knit-M-Wool": "61019010", "Coat-Knit-M-Cotton": "61012000",
            "Coat-Knit-W-Wool": "61021000", "Coat-Knit-W-Cotton": "61022000",
            "Coat-Woven-M-Wool": "62012000", "Coat-Woven-M-Cotton": "62013090",
            "Coat-Woven-W-Wool": "62022000", "Coat-Woven-W-Cotton": "62023090",
            "Shirt-Woven-M-Cotton": "62052020", "Shirt-Woven-W-Cotton": "62063010",
            "Knit Top-Knit-M-Cotton": "61091010", "Knit Top-Knit-W-Cotton": "61091010",
            "Skirt-Knit-W-Cotton": "61045200", "Skirt-Woven-W-Cotton": "62045290",
            "Dress-Knit-W-Cotton": "61044200", "Dress-Woven-W-Cotton": "62044290",
            "Pants-Knit-M-Cotton": "61034210", "Pants-Knit-W-Cotton": "61046210",
            "Pants-Woven-M-Cotton": "62034240", "Pants-Woven-W-Cotton": "62046280",
            "Goods": "42029260"
        };
        
        const GOODS_KEYWORDS = {
            "マフラー": "Scarf", "ポンチョ": "Scarf", "ストール": "Scarf",
            "帽子": "Hat", "キャップ": "Hat", "ハット": "Hat",
            "靴下": "Socks", "ソックス": "Socks",
            "バッグ": "Bag", "トート": "Bag", "ベルト": "Belt",
            "ポーチ": "Pouch"
        };
        
        const DEFAULT_PRESETS = {
            "Paper Catalog": { hs_code: "49019900", unit_value: 100, weight_per_unit: 0.1 },
            "Calendar": { hs_code: "49100000", unit_value: 50, weight_per_unit: 0.1 }
        };
        
        let presets = JSON.parse(localStorage.getItem('invoicePresets')) || DEFAULT_PRESETS;
        let generalInfo = JSON.parse(localStorage.getItem('generalInfo')) || {};
        let pricePercentage = parseFloat(localStorage.getItem('pricePercentage')) || 42;
        
        function showLoading() { document.getElementById('loadingOverlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }
        function calculatePrice(p) { return Math.round((p * (pricePercentage / 100)) / 10) * 10; }
        function getWeightByCategory(c) { return ITEM_WEIGHT_MAP[c] || 0.5; }
        function translateCategory(c) { return ITEM_CATEGORY_TRANSLATION[c] || c; }
        
        function setInvoiceNumber() {
            const yy = uploadDate.getFullYear().toString().slice(-2);
            const mm = (uploadDate.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('invoiceYYMM').value = yy + mm;
            document.getElementById('invoiceSerial').value = '';
        }
        
        function toFullWidth(str) {
            if (!str) return '';
            let result = str;
            const dakuten = {
                'ｶﾞ': 'ガ', 'ｷﾞ': 'ギ', 'ｸﾞ': 'グ', 'ｹﾞ': 'ゲ', 'ｺﾞ': 'ゴ',
                'ｻﾞ': 'ザ', 'ｼﾞ': 'ジ', 'ｽﾞ': 'ズ', 'ｾﾞ': 'ゼ', 'ｿﾞ': 'ゾ',
                'ﾀﾞ': 'ダ', 'ﾁﾞ': 'ヂ', 'ﾂﾞ': 'ヅ', 'ﾃﾞ': 'デ', 'ﾄﾞ': 'ド',
                'ﾊﾞ': 'バ', 'ﾋﾞ': 'ビ', 'ﾌﾞ': 'ブ', 'ﾍﾞ': 'ベ', 'ﾎﾞ': 'ボ',
                'ﾊﾟ': 'パ', 'ﾋﾟ': 'ピ', 'ﾌﾟ': 'プ', 'ﾍﾟ': 'ペ', 'ﾎﾟ': 'ポ', 'ｳﾞ': 'ヴ'
            };
            for (const [h, f] of Object.entries(dakuten)) result = result.split(h).join(f);
            const kanaMap = {
                'ｧ': 'ァ', 'ｱ': 'ア', 'ｨ': 'ィ', 'ｲ': 'イ', 'ｩ': 'ゥ', 'ｳ': 'ウ', 'ｪ': 'ェ', 'ｴ': 'エ', 'ｫ': 'ォ', 'ｵ': 'オ',
                'ｶ': 'カ', 'ｷ': 'キ', 'ｸ': 'ク', 'ｹ': 'ケ', 'ｺ': 'コ', 'ｻ': 'サ', 'ｼ': 'シ', 'ｽ': 'ス', 'ｾ': 'セ', 'ｿ': 'ソ',
                'ﾀ': 'タ', 'ﾁ': 'チ', 'ｯ': 'ッ', 'ﾂ': 'ツ', 'ﾃ': 'テ', 'ﾄ': 'ト', 'ﾅ': 'ナ', 'ﾆ': 'ニ', 'ﾇ': 'ヌ', 'ﾈ': 'ネ', 'ﾉ': 'ノ',
                'ﾊ': 'ハ', 'ﾋ': 'ヒ', 'ﾌ': 'フ', 'ﾍ': 'ヘ', 'ﾎ': 'ホ', 'ﾏ': 'マ', 'ﾐ': 'ミ', 'ﾑ': 'ム', 'ﾒ': 'メ', 'ﾓ': 'モ',
                'ｬ': 'ャ', 'ﾔ': 'ヤ', 'ｭ': 'ュ', 'ﾕ': 'ユ', 'ｮ': 'ョ', 'ﾖ': 'ヨ', 'ﾗ': 'ラ', 'ﾘ': 'リ', 'ﾙ': 'ル', 'ﾚ': 'レ', 'ﾛ': 'ロ',
                'ﾜ': 'ワ', 'ｦ': 'ヲ', 'ﾝ': 'ン', 'ｰ': 'ー'
            };
            for (const [h, f] of Object.entries(kanaMap)) result = result.split(h).join(f);
            return result;
        }
        
        function normalizeMaterial(m) {
            if (!m) return "Other";
            const mat = m.toString().toUpperCase().trim();
            for (const [k, b] of Object.entries(MATERIAL_BUCKETS)) {
                if (mat.includes(k.toUpperCase())) return b;
            }
            return "Other";
        }
        
        function determineKnitWoven(item, productName) {
            const itemL = (item || '').toLowerCase();
            const nameL = toFullWidth(productName || '').toLowerCase();
            const combined = itemL + ' ' + nameL;
            
            if (itemL.includes('シャツ'.toLowerCase())) return { result: 'Woven', matchType: 'item_rule' };
            if (itemL.includes('カットソー'.toLowerCase()) || itemL.includes('ニット'.toLowerCase())) 
                return { result: 'Knit', matchType: 'item_rule' };
            if (itemL.includes('グッズ'.toLowerCase())) return { result: null, matchType: 'item_rule' };
            
            const wovenKw = ['ジャージフラノ', 'ｼﾞｬｰｼﾞﾌﾗﾉ', 'denim', 'デニム', 'シャツ', 'twill', 'ツイル'];
            const knitKw = ['ニット', 'sweater', 'スウェット', 'cardigan', 'カーディガン', 'カットソー', '編み'];
            
            for (const kw of wovenKw) if (combined.includes(kw.toLowerCase())) return { result: 'Woven', matchType: 'keyword' };
            for (const kw of knitKw) if (combined.includes(kw.toLowerCase())) return { result: 'Knit', matchType: 'keyword' };
            
            const defaults = { 'ブルゾン・ジャケット': 'Woven', 'コート': 'Woven', 'スカート': 'Woven', 
                              'ワンピース': 'Woven', 'パンツ': 'Woven' };
            return { result: defaults[item] || 'Woven', matchType: 'default' };
        }
        
        function determineHSCode(row) {
            const item = row['アイテム'] || '';
            const productName = row['品名'] || '';
            const gender = (row['性別'] || '') === 'メンズ' ? 'M' : 'W';
            const material = normalizeMaterial(row['素材1']);
            
            const categoryEN = translateCategory(item);
            let description = categoryEN;
            let descMatched = true;
            
            if (item === 'グッズ') {
                const normalized = toFullWidth(productName);
                for (const [kw, trans] of Object.entries(GOODS_KEYWORDS)) {
                    if (normalized.includes(kw)) { description = trans; break; }
                }
                if (description === 'Goods') descMatched = false;
            }
            
            const kwResult = determineKnitWoven(item, productName);
            const knitWoven = kwResult.result;
            const matchType = kwResult.matchType;
            
            let hsCode = 'N/A';
            
            if (item === 'グッズ') {
                hsCode = HS_CODE_RULES['Goods'] || '42029260';
            } else if (knitWoven) {
                const key = `${categoryEN}-${knitWoven}-${gender}-${material}`;
                hsCode = HS_CODE_RULES[key];
                if (!hsCode) {
                    const keyNoMat = `${categoryEN}-${knitWoven}-${gender}`;
                    for (const rk of Object.keys(HS_CODE_RULES)) {
                        if (rk.startsWith(keyNoMat)) { hsCode = HS_CODE_RULES[rk]; break; }
                    }
                }
            }
            
            return { description, descMatched, hsCode: hsCode || 'N/A', matchType };
        }
        
        function getFirst8Digits(s) { return s ? s.toString().trim().substring(0, 8) : ''; }
        
        function processFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) { alert('Excelファイルをアップロードしてください'); return; }
            showLoading();
            uploadDate = new Date();
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    processExcelData(jsonData);
                    hideLoading();
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('controlSection').classList.add('active');
                    document.getElementById('dataSection').classList.add('active');
                    document.getElementById('noCommercialSection').classList.add('active');
                    document.getElementById('nonCommercialSection').classList.add('active');
                    setInvoiceNumber();
                    addNoCommercialRow();
                    addNonCommercialRow();
                    updateGrandTotal();
                    lucide.createIcons();
                } catch (error) {
                    hideLoading();
                    alert('ファイル読み込みエラー: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processExcelData(jsonData) {
            const validRows = jsonData.filter(r => r['品番'] && r['品名'] && r['アイテム']);
            const grouped = {};
            validRows.forEach(row => {
                const first8 = getFirst8Digits(row['品番']);
                if (!first8) return;
                if (grouped[first8]) {
                    grouped[first8].units += (row['数量'] || 0);
                } else {
                    const hsResult = determineHSCode(row);
                    grouped[first8] = {
                        itemCode: first8, units: row['数量'] || 0,
                        weightPerUnit: getWeightByCategory(row['アイテム']),
                        measure: 'PCS', description: hsResult.description,
                        matched: hsResult.descMatched, hsCode: hsResult.hsCode,
                        country: row['原産国'] || 'Japan', unitValue: calculatePrice(row['上代'] || 0),
                        totalValue: 0, matchType: hsResult.matchType
                    };
                }
            });
            productData = Object.values(grouped);
            productData.forEach(item => {
                item.totalValue = item.units * item.unitValue;
                item.weight = item.weightPerUnit * item.units;
            });
            renderDataTable();
        }
        
        function renderDataTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            let totalUnits = 0;
            productData.forEach((item, idx) => {
                totalUnits += item.units;
                const row = tbody.insertRow();
                if (item.matchType === 'default') row.classList.add('hs-match-default');
                row.innerHTML = `
                    <td><input type="text" value="${item.itemCode}"></td>
                    <td><input type="number" value="${item.units}" min="0"></td>
                    <td><input type="number" value="${item.weight.toFixed(2)}" min="0" step="0.1"></td>
                    <td><select><option value="PCS">PCS</option></select></td>
                    <td><input type="text" value="${item.description}"></td>
                    <td><input type="text" value="${item.hsCode}"></td>
                    <td><input type="text" value="${item.country}"></td>
                    <td><input type="text" class="align-right" value="${item.unitValue.toLocaleString()}"></td>
                    <td><input type="text" class="align-right" value="${item.totalValue.toLocaleString()}" readonly></td>
                `;
            });
            document.getElementById('totalItemsCount1').textContent = totalUnits;
            updateGrandTotal();
            lucide.createIcons();
        }
        
        function addNoCommercialRow() {
            noCommercialData.push({
                itemCode: '', units: 0, weight: 0, measure: 'PCS',
                description: '', hsCode: '', country: 'Japan', unitValue: 0, totalValue: 0
            });
            renderNoCommercialTable();
        }
        
        function deleteNoCommercialRow(idx) {
            if (noCommercialData.length > 1) {
                noCommercialData.splice(idx, 1);
                renderNoCommercialTable();
            } else {
                alert('最低1行は必要です / At least 1 row is required');
            }
        }
        
        function updateNoCommercialDescription(idx, val) {
            noCommercialData[idx].description = val;
            const matched = Object.keys(presets).find(n => n === val);
            if (matched) {
                const preset = presets[matched];
                noCommercialData[idx].hsCode = preset.hs_code;
                noCommercialData[idx].unitValue = preset.unit_value;
                noCommercialData[idx].weight = noCommercialData[idx].units * (preset.weight_per_unit || 0.1);
            }
            renderNoCommercialTable();
        }

        function updateNoCommercialUnits(idx, val) {
            noCommercialData[idx].units = parseInt(val) || 0;
            noCommercialData[idx].totalValue = noCommercialData[idx].units * noCommercialData[idx].unitValue;
            const matched = Object.keys(presets).find(n => n === noCommercialData[idx].description);
            if (matched && presets[matched]) {
                noCommercialData[idx].weight = noCommercialData[idx].units * (presets[matched].weight_per_unit || 0.1);
            } else {
                noCommercialData[idx].weight = noCommercialData[idx].units * 0.1;
            }
            renderNoCommercialTable();
        }

        function updateNoCommercialUnitValue(idx, val) {
            noCommercialData[idx].unitValue = parseInt(val.replace(/,/g, '')) || 0;
            noCommercialData[idx].totalValue = noCommercialData[idx].units * noCommercialData[idx].unitValue;
            renderNoCommercialTable();
        }
        
        function renderNoCommercialTable() {
            const tbody = document.getElementById('noCommercialBody');
            tbody.innerHTML = '';
            let totalUnits = 0;
            noCommercialData.forEach((item, idx) => {
                totalUnits += item.units;
                const row = tbody.insertRow();
                const presetOpts = Object.keys(presets).map(n => `<option value="${n}">`).join('');
                row.innerHTML = `
                    <td><input type="text" value="${item.itemCode}" onchange="noCommercialData[${idx}].itemCode = this.value"></td>
                    <td><input type="number" value="${item.units}" min="0" onchange="updateNoCommercialUnits(${idx}, this.value)"></td>
                    <td><input type="number" value="${item.weight.toFixed(1)}" min="0" step="0.1" onchange="noCommercialData[${idx}].weight = parseFloat(this.value) || 0"></td>
                    <td><select><option value="PCS">PCS</option></select></td>
                    <td><input type="text" value="${item.description}" onchange="updateNoCommercialDescription(${idx}, this.value)" list="presets-${idx}" placeholder="選択または入力">
                        <datalist id="presets-${idx}">${presetOpts}</datalist></td>
                    <td><input type="text" value="${item.hsCode}" readonly></td>
                    <td><input type="text" value="${item.country}" onchange="noCommercialData[${idx}].country = this.value"></td>
                    <td><input type="text" class="align-right editable-readonly" value="${item.unitValue.toLocaleString()}" onchange="updateNoCommercialUnitValue(${idx}, this.value)"></td>
                    <td><input type="text" class="align-right" value="${item.totalValue.toLocaleString()}" readonly></td>
                    <td><button class="btn-delete" onclick="deleteNoCommercialRow(${idx})"><i data-lucide="trash-2" size="16"></i></button></td>
                `;
            });
            document.getElementById('totalItemsCount2').textContent = totalUnits;
            updateGrandTotal();
            lucide.createIcons();
        }
        
        function addNonCommercialRow() {
            nonCommercialData.push({ description: '', quantity: 0 });
            renderNonCommercialTable();
        }
        
        function deleteNonCommercialRow(idx) {
            if (nonCommercialData.length > 1) {
                nonCommercialData.splice(idx, 1);
                renderNonCommercialTable();
            } else {
                alert('最低1行は必要です / At least 1 row is required');
            }
        }
        
        function renderNonCommercialTable() {
            const tbody = document.getElementById('nonCommercialBody');
            tbody.innerHTML = '';
            nonCommercialData.forEach((item, idx) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${item.description}" placeholder="Enter description"></td>
                    <td><input type="number" value="${item.quantity}" min="0"></td>
                    <td><button class="btn-delete" onclick="deleteNonCommercialRow(${idx})"><i data-lucide="trash-2" size="16"></i></button></td>
                `;
            });
            lucide.createIcons();
        }
        
        function updateGrandTotal() {
            const t1 = productData.reduce((s, i) => s + i.units, 0);
            const t2 = noCommercialData.reduce((s, i) => s + i.units, 0);
            const t3 = nonCommercialData.reduce((s, i) => s + i.quantity, 0);
            const grandTotal = t1 + t2 + t3;
            const a1 = productData.reduce((s, i) => s + i.totalValue, 0);
            const a2 = noCommercialData.reduce((s, i) => s + i.totalValue, 0);
            const grandAmount = a1 + a2;
            document.getElementById('grandTotalItems').textContent = grandTotal;
            document.getElementById('grandTotalAmount').textContent = `JPY ${grandAmount.toLocaleString()}`;
        }
        
        function generateInvoice() {
            const invoiceNo = 'RPM-EC-' + document.getElementById('invoiceYYMM').value + '-' + document.getElementById('invoiceSerial').value;
            console.log('Invoice No:', invoiceNo);
            console.log('Product Data:', productData);
            console.log('No Commercial:', noCommercialData);
            console.log('Non-Commercial:', nonCommercialData);
            console.log('General Info:', generalInfo);
            alert('インボイス生成機能は次のステップで実装します\nInvoice No: ' + invoiceNo);
        }
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        });
        
        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('click', function(e) {
            if (e.target.closest('.file-input-wrapper')) return;
            document.getElementById('fileInput').click();
        });
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => {
            dropZone.addEventListener(ev, function(e) { e.preventDefault(); e.stopPropagation(); }, false);
        });
        
        ['dragenter', 'dragover'].forEach(ev => {
            dropZone.addEventListener(ev, function() { this.classList.add('drag-over'); }, false);
        });
        
        ['dragleave', 'drop'].forEach(ev => {
            dropZone.addEventListener(ev, function() { this.classList.remove('drag-over'); }, false);
        });
        
        dropZone.addEventListener('drop', function(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) processFile(files[0]);
        }, false);

        function openGeneralInfoModal() {
            document.getElementById('generalInfoModal').classList.add('active');
            loadGeneralInfo();
        }

        function closeGeneralInfoModal() {
            document.getElementById('generalInfoModal').classList.remove('active');
        }

        function loadGeneralInfo() {
            document.getElementById('exporterName').value = generalInfo.exporterName || '45RPM STUDIO Co.,Ltd.';
            document.getElementById('exporterAddress').value = generalInfo.exporterAddress || '7-2-1 MINAMIAOYAMA, MINATO-KU, TOKYO 107-0062 JAPAN';
            document.getElementById('exporterTel').value = generalInfo.exporterTel || '81-3-3498-1345';
            document.getElementById('exporterFax').value = generalInfo.exporterFax || '81-3-3486-7145';
            document.getElementById('pricePercentage').value = pricePercentage;
            
            document.getElementById('consigneeName').value = generalInfo.consigneeName || 'FENIX LOGISTIC SERVICES LIMITED';
            document.getElementById('consigneeAddress').value = generalInfo.consigneeAddress || '4/F, Chuan Kei Factory Building, 15-23 Kin Hong Street, Kwai Chung, N.T., Hong Kong';
            document.getElementById('consigneeContact').value = generalInfo.consigneeContact || 'Kawa (Mr.) / Kit (Mr.)';
            document.getElementById('consigneeTel').value = generalInfo.consigneeTel || '2127-4660';
            document.getElementById('consigneeEmail').value = generalInfo.consigneeEmail || 'fls.wh@fls.com.hk';
            
            document.getElementById('importerName').value = generalInfo.importerName || 'Heritage R LTD.';
            document.getElementById('importerAddress').value = generalInfo.importerAddress || '36/F, TOWER 2, THE GATEWAY, 25 CANTON ROAD, TSIM SHA TSUI, KOWLOON, HONG KONG';
            document.getElementById('importerTel').value = generalInfo.importerTel || '852-2956-3266';
            document.getElementById('importerFax').value = generalInfo.importerFax || '852-2956-1230';
        }

        function saveGeneralInfo() {
            pricePercentage = parseFloat(document.getElementById('pricePercentage').value) || 42;
            localStorage.setItem('pricePercentage', pricePercentage);
            
            generalInfo = {
                exporterName: document.getElementById('exporterName').value,
                exporterAddress: document.getElementById('exporterAddress').value,
                exporterTel: document.getElementById('exporterTel').value,
                exporterFax: document.getElementById('exporterFax').value,
                
                consigneeName: document.getElementById('consigneeName').value,
                consigneeAddress: document.getElementById('consigneeAddress').value,
                consigneeContact: document.getElementById('consigneeContact').value,
                consigneeTel: document.getElementById('consigneeTel').value,
                consigneeEmail: document.getElementById('consigneeEmail').value,
                
                importerName: document.getElementById('importerName').value,
                importerAddress: document.getElementById('importerAddress').value,
                importerTel: document.getElementById('importerTel').value,
                importerFax: document.getElementById('importerFax').value
            };
            localStorage.setItem('generalInfo', JSON.stringify(generalInfo));
            alert('保存しました / Saved successfully!');
            closeGeneralInfoModal();
        }
        
        function openPresetModal() {
            document.getElementById('presetModal').classList.add('active');
            renderPresets();
        }
        
        function closePresetModal() {
            document.getElementById('presetModal').classList.remove('active');
        }
        
        function renderPresets() {
            const container = document.getElementById('presetList');
            container.innerHTML = '';
            for (const [name, data] of Object.entries(presets)) {
                const item = document.createElement('div');
                item.className = 'preset-item';
                item.innerHTML = `
                    <div><label>Description</label><input type="text" value="${name}" data-field="name" data-original="${name}"></div>
                    <div><label>HS Code</label><input type="text" value="${data.hs_code}" data-field="hs_code" data-name="${name}"></div>
                    <div><label>Unit Value (JPY)</label><input type="number" value="${data.unit_value}" data-field="unit_value" data-name="${name}"></div>
                    <button class="btn-delete" onclick="deletePreset('${name}')"><i data-lucide="trash-2" size="18"></i></button>
                `;
                container.appendChild(item);
            }
            lucide.createIcons();
        }
        
        function addNewPreset() {
            const newName = `New Item ${Object.keys(presets).length + 1}`;
            presets[newName] = { hs_code: "", unit_value: 0, weight_per_unit: 0.1 };
            renderPresets();
        }
        
        function deletePreset(name) {
            if (confirm(`Delete "${name}"?`)) { delete presets[name]; renderPresets(); }
        }
        
        function savePresets() {
            const items = document.querySelectorAll('.preset-item');
            const newPresets = {};
            items.forEach(item => {
                const nameInput = item.querySelector('[data-field="name"]');
                const hsInput = item.querySelector('[data-field="hs_code"]');
                const valueInput = item.querySelector('[data-field="unit_value"]');
                const name = nameInput.value.trim();
                if (name) {
                    newPresets[name] = {
                        hs_code: hsInput.value.trim(),
                        unit_value: parseFloat(valueInput.value) || 0,
                        weight_per_unit: 0.1
                    };
                }
            });
            presets = newPresets;
            localStorage.setItem('invoicePresets', JSON.stringify(presets));
            alert('保存しました / Presets saved successfully!');
            closePresetModal();
            renderNoCommercialTable();
        }
        
        document.getElementById('presetModal').addEventListener('click', function(e) {
            if (e.target === this) closePresetModal();
        });

        document.getElementById('generalInfoModal').addEventListener('click', function(e) {
            if (e.target === this) closeGeneralInfoModal();
        });
    </script>
</body>
</html>
