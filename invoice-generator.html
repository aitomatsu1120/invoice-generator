<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        /* ===== 強制リセット ===== */
        .invoice-preview-modal {
            display: none !important;
        }
        
        .invoice-preview-modal.active {
            display: block !important;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: #f5f7fa; }

        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: #f5f7fa; }
        
        .header {
            background-color: #1c2940;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: white;
            color: #1c2940;
        }
        
        .btn-primary:hover {
            background-color: #e8eaf0;
        }
        
        .container {
            max-width: 98%;
            margin: 1rem auto;
            padding: 0 0.5rem;
        }
        
        .upload-section {
            background: white;
            padding: 2rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-family: 'Montserrat', sans-serif;
            color: #1c2940;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }
        
        .section-subtitle {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        
        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 2rem 1.5rem;
            background-color: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drop-zone:hover {
            border-color: #64748b;
            background-color: #f1f5f9;
        }
        
        .drop-zone.drag-over {
            border-color: #1c2940;
            background-color: #e0e7ff;
            border-width: 3px;
        }
        
        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.25rem;
            pointer-events: none;
        }
        
        .drop-zone-icon { color: #94a3b8; }
        .drop-zone.drag-over .drop-zone-icon { color: #1c2940; }
        
        .drop-zone-text {
            color: #64748b;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .drop-zone.drag-over .drop-zone-text { color: #1c2940; }
        
        .or-text {
            color: #94a3b8;
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }
        
        .file-input-wrapper { position: relative; display: inline-block; }
        .file-input-wrapper input[type="file"] { display: none; }
        
        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 2rem;
            background-color: #1c2940;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.2s;
            pointer-events: auto;
        }
        
        .file-input-label:hover {
            background-color: #2a3d5f;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(28, 41, 64, 0.3);
        }
        
        .format-text {
            color: #94a3b8;
            font-size: 0.85rem;
            margin-top: 1rem;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active { display: flex; }
        
        .loading-content {
            background: white;
            padding: 2rem 3rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 1rem;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #1c2940;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #1c2940;
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .loading-subtext {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .control-section {
            display: flex;
            background: linear-gradient(135deg, #5a6c8a 0%, #6b7a94 100%);
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 2rem;
            color: white;
        }
        
        .control-section.active { display: flex; }
        
        .control-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 2rem;
        }
        
        .total-summary {
            display: flex;
            align-items: center;
            gap: 3rem;
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
        }
        
        .summary-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
        }

        .invoice-number-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .invoice-number-input span {
            font-size: 1.2rem;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
        }

        .invoice-number-input input {
            padding: 0.5rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            color: #1c2940;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            width: 80px;
            text-align: center;
        }

        .invoice-number-input input:focus {
            outline: none;
            border-color: white;
            background: white;
        }

        .invoice-number-input input.serial {
            width: 60px;
        }

        .invoice-number-input input.serial:not(:focus):invalid,
        .invoice-number-input input.serial:not(:focus):placeholder-shown {
            background-color: #ffc9c9;
        }
        
        .data-section {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .data-section.hidden { display: none; }
        .data-section.active { display: block; }
        
        .data-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .data-section-title { flex: 1; }
        
        .data-section-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .total-items {
            font-size: 0.9rem;
            color: #1c2940;
            font-weight: 600;
            padding: 0.5rem 1rem;
            background-color: #f3f4f6;
            border-radius: 6px;
        }
        
        .data-table-wrapper {
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            table-layout: fixed;
        }
        
        .data-table th {
            background-color: #1c2940;
            color: white;
            padding: 0.6rem 0.4rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .data-table th:nth-child(1) { width: 6.5%; }
        .data-table th:nth-child(2) { width: 5.5%; }
        .data-table th:nth-child(3) { width: 6.5%; }
        .data-table th:nth-child(4) { width: 7.5%; }
        .data-table th:nth-child(5) { width: 16.5%; }
        .data-table th:nth-child(6) { width: 11.5%; }
        .data-table th:nth-child(7) { width: 7.5%; }
        .data-table th:nth-child(8) { width: 11.5%; }
        .data-table th:nth-child(9) { width: 13.5%; }
        .data-table th:nth-child(10) { width: 4%; text-align: center; }
        
        .data-table td {
            padding: 0.6rem 0.4rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table td:last-child {
            text-align: center;
        }
        
        .data-table tbody tr:hover {
            background-color: #f9fafb;
        }
        
        .data-table input,
        .data-table select {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }
        
        .data-table input:focus,
        .data-table select:focus {
            outline: none;
            border-color: #1c2940;
        }
        
        .data-table input[readonly] {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }

        .data-table input.editable-readonly {
            background-color: #f9fafb;
            cursor: text;
        }

        .data-table input.editable-readonly:focus {
            background-color: white;
        }
        
        .data-table input.align-right {
            text-align: right;
        }
        
        .needs-review {
            background-color: #fef3c7 !important;
            border: 2px solid #f59e0b !important;
        }
        
        .hs-match-default {
            background-color: #f8d7da !important;
        }
        
        .btn-add-row {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }
        
        .btn-add-row:hover {
            background-color: #059669;
        }
        
        .btn-generate {
            padding: 0.75rem 2rem;
            background-color: white;
            color: #5a6c8a;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-generate:hover {
            background-color: rgba(255,255,255,0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
        
        .nc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .nc-table th {
            background-color: #1c2940;
            color: white;
            padding: 0.6rem 0.8rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .nc-table th:nth-child(1) { width: 63.5%; }
        .nc-table th:nth-child(2) { width: 22.5%; }
        .nc-table th:nth-child(3) { width: 4%; text-align: center; }
        
        .nc-table td:last-child {
            text-align: center;
        }
        
        .nc-table td {
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .nc-table input {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-family: 'Montserrat', sans-serif;
            color: #1c2940;
            font-size: 1.25rem;
        }
        
        .btn-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: #6b7280;
            transition: color 0.2s;
        }
        
        .btn-close:hover { color: #1c2940; }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .preset-item {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr auto;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            align-items: center;
            background-color: #f9fafb;
        }
        
        .preset-item input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }
        
        .preset-item label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .btn-delete {
            background-color: transparent;
            color: #ef4444;
            border: 1px solid #fecaca;
            padding: 0.35rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-delete:hover {
            background-color: #fee2e2;
            color: #dc2626;
            border-color: #fca5a5;
        }
        
        .btn-add {
            width: 100%;
            padding: 0.75rem;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 1rem;
            transition: background-color 0.2s;
        }
        
        .btn-add:hover { background-color: #059669; }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover { background-color: #d1d5db; }
        
        .btn-save {
            background-color: #1c2940;
            color: white;
        }
        
        .btn-save:hover { background-color: #2a3d5f; }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
        }

        .form-section h4 {
            font-family: 'Montserrat', sans-serif;
            color: #1c2940;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            padding: 0.625rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1c2940;
        }

     /* ===== Invoice Preview Modal Styles ===== */
    .invoice-preview-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        z-index: 2000;
        overflow-y: auto;
    }
    
    .invoice-preview-modal.active {
        display: block;
    }
    
    .invoice-preview-container {
        max-width: 210mm; /* A4 width */
        margin: 2rem auto;
        background: white;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    
    .invoice-preview-header {
        position: sticky;
        top: 0;
        background: #1c2940;
        color: white;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .invoice-preview-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .invoice-preview-actions {
        display: flex;
        gap: 0.75rem;
    }
    
    .btn-back {
        background-color: transparent;
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
    }
    
    .btn-back:hover {
        background-color: rgba(255,255,255,0.1);
        border-color: white;
    }
    
    .btn-print {
        background-color: white;
        color: #1c2940;
    }
    
    .btn-print:hover {
        background-color: #e8eaf0;
    }
    
    .btn-disabled {
        opacity: 0.5;
        cursor: not-allowed;
        position: relative;
    }
    
    .btn-disabled:hover::after {
        content: 'Coming Soon';
        position: absolute;
        bottom: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: #374151;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.75rem;
        white-space: nowrap;
    }
    
    /* Invoice Document Styles */
    .invoice-document {
        padding: 13mm;
        background: white;
        min-height: 297mm; /* A4 height */
    }
    
    .invoice-logo-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #1c2940;
    }
    
    .invoice-logo {
        width: 120px;
    }
    
    .invoice-company-info {
        text-align: right;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 0.75rem;
        line-height: 1.4;
        color: #1c2940;
    }
    
    .invoice-company-name {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
    }
    
    .invoice-title-section {
        text-align: center;
        margin: 1.1rem 0;
    }
    
    .invoice-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 1.3rem;
        font-weight: 700;
        color: #1c2940;
        margin-bottom: 0.5rem;
    }
    
    .invoice-page-number {
        font-size: 0.65rem;
        color: #64748b;
    }
    
    .invoice-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
        font-size: 0.55rem;
    }
    
    .invoice-info-block h4 {
        font-weight: 700;
        color: #1c2940;
        margin-bottom: 0.5rem;
        font-size: 0.55rem;
    }
    
    .invoice-info-block p {
        margin: 0.35rem 0;
        line-height: 1.4;
        color: #374151;
    }
    
    .invoice-info-label {
        font-weight: 600;
        color: #1c2940;
    }
    
    .invoice-table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5rem 0;
        font-size: 0.65rem;
    }
    
    .invoice-table th {
        background-color: #1c2940;
        color: white;
        padding: 0.4rem 0.25rem;
        text-align: center;
        font-weight: 600;
        font-size: 0.5rem;
        border: 1px solid #1c2940;
    }
    
    .invoice-table td {
        padding: 0.45rem 0.35rem;
        border: 1px solid #d1d5db;
        vertical-align: top;
        text-align: center;
    }
    
    .invoice-table tbody tr:nth-child(even) {
        background-color: #f9fafb;
    }
    
    .invoice-table .align-right {
        text-align: right !important;
    }
    
    .invoice-totals {
        margin-top: 2rem;
        display: flex;
        justify-content: flex-end;
    }
    
    .invoice-totals-table {
        width: 40%;
        font-size: 0.85rem;
    }
    
    .invoice-totals-table tr td {
        padding: 0.4rem 0.75rem;
        border: none;
    }
    
    .invoice-totals-table tr td:first-child {
        text-align: right;
        font-weight: 600;
        color: #1c2940;
    }
    
    .invoice-totals-table tr td:last-child {
        text-align: right;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .invoice-totals-table tr:last-child td {
        font-weight: 700;
        font-size: 1rem;
        color: #1c2940;
        border-top: 2px solid #1c2940;
        border-bottom: 2px solid #1c2940;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
    }
    
    .invoice-footer {
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }
    
    .invoice-declaration {
        font-size: 0.8rem;
        margin-bottom: 1rem;
    }
    
    .invoice-signature {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
    }
    
    .invoice-signature-line {
        width: 45%;
        border-top: 1px solid #1c2940;
        padding-top: 0.5rem;
        font-size: 0.75rem;
        color: #64748b;
    }
    
    .invoice-notes {
        margin-top: 1.5rem;
        padding: 1rem;
        background-color: #f9fafb;
        border-left: 3px solid #1c2940;
        font-size: 0.8rem;
        color: #374151;
    }
    
    /* Print Styles */
    @media print {
        body * {
            visibility: hidden;
        }
        
        .invoice-preview-modal,
        .invoice-preview-modal * {
            visibility: visible;
        }
        
        .invoice-preview-modal {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: auto;
            background: white;
            overflow: visible;
        }
        
        .invoice-preview-header {
            display: none !important;
        }
        
        .invoice-preview-container {
            max-width: 100%;
            margin: 0;
            box-shadow: none;
        }
        
        .invoice-document {
            padding: 0;
            min-height: auto;
        }
        
        @page {
            size: A4;
            margin: 15mm;
        }
    }

        
    </style>
</head>
<body>
    <header class="header">
        <div class="header-title">
            <i data-lucide="package" size="28"></i>
            Invoice Generator
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openGeneralInfoModal()">
                <i data-lucide="file-text" size="18"></i>
                General Info
            </button>
            <button class="btn btn-primary" onclick="openPresetModal()">
                <i data-lucide="settings" size="18"></i>
                Manage Presets
            </button>
        </div>
    </header>
    
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">処理中... / Processing...</div>
            <div class="loading-subtext">ファイルを読み込んでいます / Reading file</div>
        </div>
    </div>
    
    <div class="container">
        <div id="uploadSection" class="upload-section">
            <h2 class="section-title">商品明細のエクセルファイルをアップロード（オプション）</h2>
            <p class="section-subtitle">Upload Product List Excel File (Optional)</p>
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-content">
                    <div class="drop-zone-icon">
                        <i data-lucide="file-spreadsheet" size="48"></i>
                    </div>
                    <p class="drop-zone-text">ファイルをドラッグ&ドロップ / Drag & Drop File</p>
                    <p class="or-text">または / or</p>
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" accept=".xlsx,.xls">
                        <label for="fileInput" class="file-input-label">
                            <i data-lucide="upload" size="18"></i>
                            Choose File
                        </label>
                    </div>
                    <p class="format-text">.xlsx または .xls 形式 / .xlsx or .xls format</p>
                </div>
            </div>
        </div>
        
        <div id="controlSection" class="control-section">
            <div class="control-content">
                <div class="total-summary">
                    <div class="summary-item">
                        <span class="summary-label">Invoice No.</span>
                        <div class="invoice-number-input">
                            <span>RPM-EC-</span>
                            <input type="text" id="invoiceYYMM" maxlength="4" placeholder="YYMM">
                            <span>-</span>
                            <input type="text" id="invoiceSerial" class="serial" maxlength="3" required>
                        </div>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">全体合計点数 / Total Items</span>
                        <span class="summary-value" id="grandTotalItems">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">請求金額 / Invoice Amount</span>
                        <span class="summary-value" id="grandTotalAmount">JPY 0</span>
                    </div>
                </div>
                <button class="btn-generate" onclick="generateInvoice()">
                    <i data-lucide="file-text" size="20"></i>
                    インボイスを生成
                </button>
            </div>
        </div>
        
        <div id="dataSection" class="data-section hidden">
            <div class="data-section-header">
                <div class="data-section-title">
                    <h2 class="section-title">商品明細リスト / Product Details List</h2>
                    <p class="section-subtitle">編集可能です / Editable</p>
                </div>
                <div class="data-section-info">
                    <div class="total-items">
                        合計点数 / Total: <span id="totalItemsCount1">0</span>
                    </div>
                </div>
            </div>
            
            <div class="data-table-wrapper">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>No. of Units</th>
                            <th>Net Weight (KG)</th>
                            <th>Unit of Measure</th>
                            <th>Description of Goods</th>
                            <th>Harmonized Tariff Number</th>
                            <th>Country/Terr. of MFR</th>
                            <th>Unit Value (JPY)</th>
                            <th>Total Value (JPY)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <div id="noCommercialSection" class="data-section">
            <div class="data-section-header">
                <div class="data-section-title">
                    <h2 class="section-title">販促物・有償提供品 / Promotional Items (Commercial Value)</h2>
                    <p class="section-subtitle">カタログ・販促物など / Catalogs, Promotional Materials</p>
                </div>
                <div class="data-section-info">
                    <div class="total-items">
                        合計点数 / Total: <span id="totalItemsCount2">0</span>
                    </div>
                </div>
            </div>
            
            <div class="data-table-wrapper">
                <table class="data-table" id="noCommercialTable">
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>No. of Units</th>
                            <th>Net Weight (KG)</th>
                            <th>Unit of Measure</th>
                            <th>Description of Goods</th>
                            <th>Harmonized Tariff Number</th>
                            <th>Country/Terr. of MFR</th>
                            <th>Unit Value (JPY)</th>
                            <th>Total Value (JPY)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="noCommercialBody"></tbody>
                </table>
            </div>
            
            <button class="btn-add-row" onclick="addNoCommercialRow()">
                <i data-lucide="plus" size="16"></i>
                行を追加 / Add Row
            </button>
        </div>
        
        <div id="nonCommercialSection" class="data-section">
            <div class="data-section-header">
                <div class="data-section-title">
                    <h2 class="section-title">無償提供品 / Non-Commercial Value Items</h2>
                    <p class="section-subtitle">無償サンプル・資料など / Free Samples, Documents (金額に含まれません / Not included in invoice amount)</p>
                </div>
            </div>
            
            <div class="data-table-wrapper">
                <table class="nc-table" id="nonCommercialTable">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="nonCommercialBody"></tbody>
                </table>
            </div>
            
            <button class="btn-add-row" onclick="addNonCommercialRow()">
                <i data-lucide="plus" size="16"></i>
                行を追加 / Add Row
            </button>
        </div>
    </div>
    
    <div id="generalInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>General Information / 基本情報</h3>
                <button class="btn-close" onclick="closeGeneralInfoModal()">
                    <i data-lucide="x" size="24"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4>EXPORTER / 輸出者</h4>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Company Name / 会社名</label>
                            <input type="text" id="exporterName" value="45RPM STUDIO Co.,Ltd.">
                        </div>
                        <div class="form-group full-width">
                            <label>Address / 住所</label>
                            <textarea id="exporterAddress">7-2-1 MINAMIAOYAMA, MINATO-KU, TOKYO 107-0062 JAPAN</textarea>
                        </div>
                        <div class="form-group">
                            <label>TEL</label>
                            <input type="text" id="exporterTel" value="81-3-3498-1345">
                        </div>
                        <div class="form-group">
                            <label>FAX</label>
                            <input type="text" id="exporterFax" value="81-3-3486-7145">
                        </div>
                        <div class="form-group">
                            <label>卸値パーセンテージ / Wholesale Percentage (%)</label>
                            <input type="number" id="pricePercentage" value="42" min="0" max="100" step="1">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h4>CONSIGNEE / 荷受人（実際の配送先）</h4>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Company Name / 会社名</label>
                            <input type="text" id="consigneeName" value="FENIX LOGISTIC SERVICES LIMITED">
                        </div>
                        <div class="form-group full-width">
                            <label>Address / 住所</label>
                            <textarea id="consigneeAddress">4/F, Chuan Kei Factory Building, 15-23 Kin Hong Street, Kwai Chung, N.T., Hong Kong</textarea>
                        </div>
                        <div class="form-group">
                            <label>Contact Person / 担当者</label>
                            <input type="text" id="consigneeContact" value="Kawa (Mr.) / Kit (Mr.)">
                        </div>
                        <div class="form-group">
                            <label>TEL</label>
                            <input type="text" id="consigneeTel" value="2127-4660">
                        </div>
                        <div class="form-group full-width">
                            <label>Email</label>
                            <input type="email" id="consigneeEmail" value="fls.wh@fls.com.hk">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h4>SOLD TO / IMPORTER / 買主・輸入者</h4>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Company Name / 会社名</label>
                            <input type="text" id="importerName" value="Heritage R LTD.">
                        </div>
                        <div class="form-group full-width">
                            <label>Address / 住所</label>
                            <textarea id="importerAddress">36/F, TOWER 2, THE GATEWAY, 25 CANTON ROAD, TSIM SHA TSUI, KOWLOON, HONG KONG</textarea>
                        </div>
                        <div class="form-group">
                            <label>TEL</label>
                            <input type="text" id="importerTel" value="852-2956-3266">
                        </div>
                        <div class="form-group">
                            <label>FAX</label>
                            <input type="text" id="importerFax" value="852-2956-1230">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGeneralInfoModal()">Cancel</button>
                <button class="btn btn-save" onclick="saveGeneralInfo()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="presetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Preset Goods</h3>
                <button class="btn-close" onclick="closePresetModal()">
                    <i data-lucide="x" size="24"></i>
                </button>
            </div>
            <div class="modal-body" id="presetList"></div>
            <div style="padding: 0 1.5rem;">
                <button class="btn-add" onclick="addNewPreset()">
                    <i data-lucide="plus" size="18"></i> Add New Preset
                </button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePresetModal()">Cancel</button>
                <button class="btn btn-save" onclick="savePresets()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        lucide.createIcons();
        
        let productData = [];
        let noCommercialData = [];
        let nonCommercialData = [];
        let uploadDate = new Date();
        
        // 初期化：デフォルト行を追加
        window.addEventListener('DOMContentLoaded', function() {
            addNoCommercialRow();
            addNonCommercialRow();
            setInvoiceNumber();
            lucide.createIcons();
        });
        
        const ITEM_WEIGHT_MAP = {
            "ブルゾン・ジャケット": 0.8, "コート": 1.2, "シャツ": 0.3,
            "スカート": 0.4, "ワンピース": 0.5, "パンツ": 0.5,
            "カットソー": 0.3, "ニット": 0.4, "グッズ": 0.2
        };
        
        const ITEM_CATEGORY_TRANSLATION = {
            "ブルゾン・ジャケット": "Jacket", "コート": "Coat", "シャツ": "Shirt",
            "スカート": "Skirt", "ワンピース": "Dress", "パンツ": "Pants",
            "カットソー": "Knit Top", "ニット": "Knit Top", "グッズ": "Goods"
        };
        
        const MATERIAL_BUCKETS = {
            'ウール': 'Wool', '毛': 'Wool', 'アルパカ': 'Wool', 'WOOL': 'Wool',
            'カシミヤ': 'Cashmere', 'カシミア': 'Cashmere', 'CASHMERE': 'Cashmere',
            'コットン': 'Cotton', '綿': 'Cotton', 'COTTON': 'Cotton',
            'ポリエステル': 'Synthetic', 'ナイロン': 'Synthetic', 'アクリル': 'Synthetic',
            'レーヨン': 'Artificial', 'RAYON': 'Artificial', 'VISCOSE': 'Artificial',
            'シルク': 'Silk', '絹': 'Silk', 'SILK': 'Silk'
        };
        
        const HS_CODE_RULES = {
            "Jacket-Knit-M-Wool": "61033100", "Jacket-Knit-M-Cotton": "61033200",
            "Jacket-Knit-W-Wool": "61043100", "Jacket-Knit-W-Cotton": "61043200",
            "Jacket-Woven-M-Wool": "62033100", "Jacket-Woven-M-Cotton": "62033290",
            "Jacket-Woven-W-Wool": "62043100", "Jacket-Woven-W-Cotton": "62043290",
            "Coat-Knit-M-Wool": "61019010", "Coat-Knit-M-Cotton": "61012000",
            "Coat-Knit-W-Wool": "61021000", "Coat-Knit-W-Cotton": "61022000",
            "Coat-Woven-M-Wool": "62012000", "Coat-Woven-M-Cotton": "62013090",
            "Coat-Woven-W-Wool": "62022000", "Coat-Woven-W-Cotton": "62023090",
            "Shirt-Woven-M-Cotton": "62052020", "Shirt-Woven-W-Cotton": "62063010",
            "Knit Top-Knit-M-Cotton": "61091010", "Knit Top-Knit-W-Cotton": "61091010",
            "Skirt-Knit-W-Cotton": "61045200", "Skirt-Woven-W-Cotton": "62045290",
            "Dress-Knit-W-Cotton": "61044200", "Dress-Woven-W-Cotton": "62044290",
            "Pants-Knit-M-Cotton": "61034210", "Pants-Knit-W-Cotton": "61046210",
            "Pants-Woven-M-Cotton": "62034240", "Pants-Woven-W-Cotton": "62046280",
            "Goods": "42029260"
        };
        
        const GOODS_KEYWORDS = {
            "マフラー": "Scarf", "ポンチョ": "Scarf", "ストール": "Scarf",
            "帽子": "Hat", "キャップ": "Hat", "ハット": "Hat",
            "靴下": "Socks", "ソックス": "Socks",
            "バッグ": "Bag", "トート": "Bag", "ベルト": "Belt",
            "ポーチ": "Pouch"
        };

        const COUNTRY_CODE_MAP = {
            'Japan': 'JP',
            'China': 'CN',
            'Vietnam': 'VN',
            'India': 'IN'
        };
        
        const DEFAULT_PRESETS = {
            "Paper Catalog": { hs_code: "49019900", unit_value: 100, weight_per_unit: 0.1 },
            "Calendar": { hs_code: "49100000", unit_value: 50, weight_per_unit: 0.1 }
        };
        
        let presets = JSON.parse(localStorage.getItem('invoicePresets')) || DEFAULT_PRESETS;
        let generalInfo = JSON.parse(localStorage.getItem('generalInfo')) || {};
        let pricePercentage = parseFloat(localStorage.getItem('pricePercentage')) || 42;
        
        function showLoading() { document.getElementById('loadingOverlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }
        function calculatePrice(p) { return Math.round((p * (pricePercentage / 100)) / 10) * 10; }
        function getWeightByCategory(c) { return ITEM_WEIGHT_MAP[c] || 0.5; }
        function translateCategory(c) { return ITEM_CATEGORY_TRANSLATION[c] || c; }
        
        function setInvoiceNumber() {
            const yy = uploadDate.getFullYear().toString().slice(-2);
            const mm = (uploadDate.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('invoiceYYMM').value = yy + mm;
            document.getElementById('invoiceSerial').value = '';
        }
        
        function toFullWidth(str) {
            if (!str) return '';
            let result = str;
            const dakuten = {
                'ｶﾞ': 'ガ', 'ｷﾞ': 'ギ', 'ｸﾞ': 'グ', 'ｹﾞ': 'ゲ', 'ｺﾞ': 'ゴ',
                'ｻﾞ': 'ザ', 'ｼﾞ': 'ジ', 'ｽﾞ': 'ズ', 'ｾﾞ': 'ゼ', 'ｿﾞ': 'ゾ',
                'ﾀﾞ': 'ダ', 'ﾁﾞ': 'ヂ', 'ﾂﾞ': 'ヅ', 'ﾃﾞ': 'デ', 'ﾄﾞ': 'ド',
                'ﾊﾞ': 'バ', 'ﾋﾞ': 'ビ', 'ﾌﾞ': 'ブ', 'ﾍﾞ': 'ベ', 'ﾎﾞ': 'ボ',
                'ﾊﾟ': 'パ', 'ﾋﾟ': 'ピ', 'ﾌﾟ': 'プ', 'ﾍﾟ': 'ペ', 'ﾎﾟ': 'ポ', 'ｳﾞ': 'ヴ'
            };
            for (const [h, f] of Object.entries(dakuten)) result = result.split(h).join(f);
            const kanaMap = {
                'ｧ': 'ァ', 'ｱ': 'ア', 'ｨ': 'ィ', 'ｲ': 'イ', 'ｩ': 'ゥ', 'ｳ': 'ウ', 'ｪ': 'ェ', 'ｴ': 'エ', 'ｫ': 'ォ', 'ｵ': 'オ',
                'ｶ': 'カ', 'ｷ': 'キ', 'ｸ': 'ク', 'ｹ': 'ケ', 'ｺ': 'コ', 'ｻ': 'サ', 'ｼ': 'シ', 'ｽ': 'ス', 'ｾ': 'セ', 'ｿ': 'ソ',
                'ﾀ': 'タ', 'ﾁ': 'チ', 'ｯ': 'ッ', 'ﾂ': 'ツ', 'ﾃ': 'テ', 'ﾄ': 'ト', 'ﾅ': 'ナ', 'ﾆ': 'ニ', 'ﾇ': 'ヌ', 'ﾈ': 'ネ', 'ﾉ': 'ノ',
                'ﾊ': 'ハ', 'ﾋ': 'ヒ', 'ﾌ': 'フ', 'ﾍ': 'ヘ', 'ﾎ': 'ホ', 'ﾏ': 'マ', 'ﾐ': 'ミ', 'ﾑ': 'ム', 'ﾒ': 'メ', 'ﾓ': 'モ',
                'ｬ': 'ャ', 'ﾔ': 'ヤ', 'ｭ': 'ュ', 'ﾕ': 'ユ', 'ｮ': 'ョ', 'ﾖ': 'ヨ', 'ﾗ': 'ラ', 'ﾘ': 'リ', 'ﾙ': 'ル', 'ﾚ': 'レ', 'ﾛ': 'ロ',
                'ﾜ': 'ワ', 'ｦ': 'ヲ', 'ﾝ': 'ン', 'ｰ': 'ー'
            };
            for (const [h, f] of Object.entries(kanaMap)) result = result.split(h).join(f);
            return result;
        }
        
        function normalizeMaterial(m) {
            if (!m) return "Other";
            const mat = m.toString().toUpperCase().trim();
            for (const [k, b] of Object.entries(MATERIAL_BUCKETS)) {
                if (mat.includes(k.toUpperCase())) return b;
            }
            return "Other";
        }

        function convertCountryCode(country) {
            if (!country) return 'JP';
            const trimmed = country.toString().trim();
            return COUNTRY_CODE_MAP[trimmed] || trimmed;
        }
        
        function determineKnitWoven(item, productName) {
            const itemL = (item || '').toLowerCase();
            const nameL = toFullWidth(productName || '').toLowerCase();
            const combined = itemL + ' ' + nameL;
            
            if (itemL.includes('シャツ'.toLowerCase())) return { result: 'Woven', matchType: 'item_rule' };
            if (itemL.includes('カットソー'.toLowerCase()) || itemL.includes('ニット'.toLowerCase())) 
                return { result: 'Knit', matchType: 'item_rule' };
            if (itemL.includes('グッズ'.toLowerCase())) return { result: null, matchType: 'item_rule' };
            
            const wovenKw = ['ジャージフラノ', 'ｼﾞｬｰｼﾞﾌﾗﾉ', 'denim', 'デニム', 'シャツ', 'twill', 'ツイル'];
            const knitKw = ['ニット', 'sweater', 'スウェット', 'cardigan', 'カーディガン', 'カットソー', '編み'];
            
            for (const kw of wovenKw) if (combined.includes(kw.toLowerCase())) return { result: 'Woven', matchType: 'keyword' };
            for (const kw of knitKw) if (combined.includes(kw.toLowerCase())) return { result: 'Knit', matchType: 'keyword' };
            
            const defaults = { 'ブルゾン・ジャケット': 'Woven', 'コート': 'Woven', 'スカート': 'Woven', 
                              'ワンピース': 'Woven', 'パンツ': 'Woven' };
            return { result: defaults[item] || 'Woven', matchType: 'default' };
        }
        
        function determineHSCode(row) {
            const item = row['アイテム'] || '';
            const productName = row['品名'] || '';
            const gender = (row['性別'] || '') === 'メンズ' ? 'M' : 'W';
            const material = normalizeMaterial(row['素材1']);
            
            const categoryEN = translateCategory(item);
            let description = categoryEN;
            let descMatched = true;
            
            if (item === 'グッズ') {
                const normalized = toFullWidth(productName);
                for (const [kw, trans] of Object.entries(GOODS_KEYWORDS)) {
                    if (normalized.includes(kw)) { description = trans; break; }
                }
                if (description === 'Goods') descMatched = false;
            }
            
            const kwResult = determineKnitWoven(item, productName);
            const knitWoven = kwResult.result;
            const matchType = kwResult.matchType;
            
            let hsCode = 'N/A';
            
            if (item === 'グッズ') {
                hsCode = HS_CODE_RULES['Goods'] || '42029260';
            } else if (knitWoven) {
                const key = `${categoryEN}-${knitWoven}-${gender}-${material}`;
                hsCode = HS_CODE_RULES[key];
                if (!hsCode) {
                    const keyNoMat = `${categoryEN}-${knitWoven}-${gender}`;
                    for (const rk of Object.keys(HS_CODE_RULES)) {
                        if (rk.startsWith(keyNoMat)) { hsCode = HS_CODE_RULES[rk]; break; }
                    }
                }
            }
            
            return { description, descMatched, hsCode: hsCode || 'N/A', matchType };
        }
        
        function getFirst8Digits(s) { return s ? s.toString().trim().substring(0, 8) : ''; }
        
        function processFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) { alert('Excelファイルをアップロードしてください'); return; }
            showLoading();
            uploadDate = new Date();
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    processExcelData(jsonData);
                    hideLoading();
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('dataSection').classList.add('active');
                    setInvoiceNumber();
                    updateGrandTotal();
                    lucide.createIcons();
                } catch (error) {
                    hideLoading();
                    alert('ファイル読み込みエラー: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processExcelData(jsonData) {
            const validRows = jsonData.filter(r => r['品番'] && r['品名'] && r['アイテム']);
            const grouped = {};
            validRows.forEach(row => {
                const first8 = getFirst8Digits(row['品番']);
                if (!first8) return;
                if (grouped[first8]) {
                    grouped[first8].units += (row['数量'] || 0);
                    const cno = row['C/No.'] || 1;
                    if (!grouped[first8].packageNos.includes(cno)) {
                        grouped[first8].packageNos.push(cno);
                    }
                } else {
                    const hsResult = determineHSCode(row);
                    grouped[first8] = {
                        itemCode: first8, units: row['数量'] || 0,
                        weightPerUnit: getWeightByCategory(row['アイテム']),
                        measure: 'PCS', description: hsResult.description,
                        matched: hsResult.descMatched, hsCode: hsResult.hsCode,
                        country: convertCountryCode(row['原産国']), unitValue: calculatePrice(row['上代'] || 0),
                        totalValue: 0, matchType: hsResult.matchType,
                        packageNos: [row['C/No.'] || 1]
                    };
                }
            });
            productData = Object.values(grouped);
            productData.forEach(item => {
                item.totalValue = item.units * item.unitValue;
                item.weight = item.weightPerUnit * item.units;
                item.packageCount = item.packageNos.length;
                item.remarksText = item.packageNos.length > 0 
                    ? 'C/No. ' + item.packageNos.sort((a,b) => a-b).join(', ')
                    : '';
            });
            renderDataTable();
        }
        
        function renderDataTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            let totalUnits = 0;
            productData.forEach((item, idx) => {
                totalUnits += item.units;
                const row = tbody.insertRow();
                if (item.matchType === 'default') row.classList.add('hs-match-default');
                row.innerHTML = `
                    <td><input type="text" value="${item.itemCode}"></td>
                    <td><input type="number" value="${item.units}" min="0"></td>
                    <td><input type="number" value="${item.weight.toFixed(2)}" min="0" step="0.1"></td>
                    <td><select><option value="PCS">PCS</option></select></td>
                    <td><input type="text" value="${item.description}"></td>
                    <td><input type="text" value="${item.hsCode}"></td>
                    <td><input type="text" value="${item.country}"></td>
                    <td><input type="text" class="align-right" value="${item.unitValue.toLocaleString()}"></td>
                    <td><input type="text" class="align-right" value="${item.totalValue.toLocaleString()}" readonly></td>
                `;
            });
            document.getElementById('totalItemsCount1').textContent = totalUnits;
            updateGrandTotal();
            lucide.createIcons();
        }
        
        function addNoCommercialRow() {
            noCommercialData.push({
                itemCode: '', units: 0, weight: 0, measure: 'PCS',
                description: '', hsCode: '', country: 'JP', unitValue: 0, totalValue: 0
            });
            renderNoCommercialTable();
        }
        
        function deleteNoCommercialRow(idx) {
            if (idx === 0) {
                alert('最初の行は削除できません / Cannot delete the first row');
                return;
            }
            noCommercialData.splice(idx, 1);
            renderNoCommercialTable();
        }
        
        function updateNoCommercialDescription(idx, val) {
            noCommercialData[idx].description = val;
            const matched = Object.keys(presets).find(n => n === val);
            if (matched) {
                const preset = presets[matched];
                noCommercialData[idx].hsCode = preset.hs_code;
                noCommercialData[idx].unitValue = preset.unit_value;
                noCommercialData[idx].weight = noCommercialData[idx].units * (preset.weight_per_unit || 0.1);
            }
            renderNoCommercialTable();
        }

        function updateNoCommercialUnits(idx, val) {
            noCommercialData[idx].units = parseInt(val) || 0;
            noCommercialData[idx].totalValue = noCommercialData[idx].units * noCommercialData[idx].unitValue;
            const matched = Object.keys(presets).find(n => n === noCommercialData[idx].description);
            if (matched && presets[matched]) {
                noCommercialData[idx].weight = noCommercialData[idx].units * (presets[matched].weight_per_unit || 0.1);
            } else {
                noCommercialData[idx].weight = noCommercialData[idx].units * 0.1;
            }
            renderNoCommercialTable();
        }

        function updateNoCommercialUnitValue(idx, val) {
            noCommercialData[idx].unitValue = parseInt(val.replace(/,/g, '')) || 0;
            noCommercialData[idx].totalValue = noCommercialData[idx].units * noCommercialData[idx].unitValue;
            renderNoCommercialTable();
        }
        
        function renderNoCommercialTable() {
            const tbody = document.getElementById('noCommercialBody');
            tbody.innerHTML = '';
            let totalUnits = 0;
            noCommercialData.forEach((item, idx) => {
                totalUnits += item.units;
                const row = tbody.insertRow();
                const presetOpts = Object.keys(presets).map(n => `<option value="${n}">`).join('');
                row.innerHTML = `
                    <td><input type="text" value="${item.itemCode}" onchange="noCommercialData[${idx}].itemCode = this.value"></td>
                    <td><input type="number" value="${item.units}" min="0" onchange="updateNoCommercialUnits(${idx}, this.value)"></td>
                    <td><input type="number" value="${item.weight.toFixed(1)}" min="0" step="0.1" onchange="noCommercialData[${idx}].weight = parseFloat(this.value) || 0"></td>
                    <td><select><option value="PCS">PCS</option></select></td>
                    <td><input type="text" value="${item.description}" onchange="updateNoCommercialDescription(${idx}, this.value)" list="presets-${idx}" placeholder="選択または入力">
                        <datalist id="presets-${idx}">${presetOpts}</datalist></td>
                    <td><input type="text" value="${item.hsCode}" readonly></td>
                    <td><input type="text" value="${item.country}" onchange="noCommercialData[${idx}].country = this.value"></td>
                    <td><input type="text" class="align-right editable-readonly" value="${item.unitValue.toLocaleString()}" onchange="updateNoCommercialUnitValue(${idx}, this.value)"></td>
                    <td><input type="text" class="align-right" value="${item.totalValue.toLocaleString()}" readonly></td>
                    <td><button class="btn-delete" onclick="deleteNoCommercialRow(${idx})"><i data-lucide="trash-2" size="16"></i></button></td>
                `;
            });
            document.getElementById('totalItemsCount2').textContent = totalUnits;
            updateGrandTotal();
            lucide.createIcons();
        }
        
        function addNonCommercialRow() {
            nonCommercialData.push({ description: '', quantity: 0 });
            renderNonCommercialTable();
        }
        
        function deleteNonCommercialRow(idx) {
            if (idx === 0) {
                alert('最初の行は削除できません / Cannot delete the first row');
                return;
            }
            nonCommercialData.splice(idx, 1);
            renderNonCommercialTable();
        }
        
        function renderNonCommercialTable() {
            const tbody = document.getElementById('nonCommercialBody');
            tbody.innerHTML = '';
            nonCommercialData.forEach((item, idx) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${item.description}" placeholder="Enter description"></td>
                    <td><input type="number" value="${item.quantity}" min="0"></td>
                    <td><button class="btn-delete" onclick="deleteNonCommercialRow(${idx})"><i data-lucide="trash-2" size="16"></i></button></td>
                `;
            });
            lucide.createIcons();
        }
        
        function updateGrandTotal() {
            const t1 = productData.reduce((s, i) => s + i.units, 0);
            const t2 = noCommercialData.reduce((s, i) => s + i.units, 0);
            const t3 = nonCommercialData.reduce((s, i) => s + i.quantity, 0);
            const grandTotal = t1 + t2 + t3;
            const a1 = productData.reduce((s, i) => s + i.totalValue, 0);
            const a2 = noCommercialData.reduce((s, i) => s + i.totalValue, 0);
            const grandAmount = a1 + a2;
            document.getElementById('grandTotalItems').textContent = grandTotal;
            document.getElementById('grandTotalAmount').textContent = `JPY ${grandAmount.toLocaleString()}`;
        }
        
        function generateInvoice() {
            // バリデーション：3桁の連番のみチェック
            const serialInput = document.getElementById('invoiceSerial').value;
            
            if (!serialInput || serialInput.length !== 3) {
                alert('Invoice番号の連番（3桁）を入力してください\nPlease enter the 3-digit serial number');
                document.getElementById('invoiceSerial').focus();
                return;
            }
            
            const yymmInput = document.getElementById('invoiceYYMM').value;
            const invoiceNo = 'RPM-EC-' + yymmInput + '-' + serialInput;
            
            console.log('=== DEBUG START ===');
            console.log('Invoice No:', invoiceNo);
            console.log('Modal element:', document.getElementById('invoicePreviewModal'));
            console.log('openInvoicePreview function exists:', typeof openInvoicePreview);
            
            // テスト：モーダルが存在するか
            const modal = document.getElementById('invoicePreviewModal');
            if (!modal) {
                alert('エラー: invoicePreviewModal が見つかりません');
                return;
            }
            
            // プレビューモーダルを開く
            try {
                openInvoicePreview(invoiceNo);
            } catch (error) {
                console.error('Error:', error);
                alert('エラーが発生しました: ' + error.message);
            }
        }
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        });
        
        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('click', function(e) {
            if (e.target.closest('.file-input-wrapper')) return;
            document.getElementById('fileInput').click();
        });
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => {
            dropZone.addEventListener(ev, function(e) { e.preventDefault(); e.stopPropagation(); }, false);
        });
        
        ['dragenter', 'dragover'].forEach(ev => {
            dropZone.addEventListener(ev, function() { this.classList.add('drag-over'); }, false);
        });
        
        ['dragleave', 'drop'].forEach(ev => {
            dropZone.addEventListener(ev, function() { this.classList.remove('drag-over'); }, false);
        });
        
        dropZone.addEventListener('drop', function(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) processFile(files[0]);
        }, false);

        function openGeneralInfoModal() {
            document.getElementById('generalInfoModal').classList.add('active');
            loadGeneralInfo();
        }

        function closeGeneralInfoModal() {
            document.getElementById('generalInfoModal').classList.remove('active');
        }

        function loadGeneralInfo() {
            document.getElementById('exporterName').value = generalInfo.exporterName || '45RPM STUDIO Co.,Ltd.';
            document.getElementById('exporterAddress').value = generalInfo.exporterAddress || '7-2-1 MINAMIAOYAMA, MINATO-KU, TOKYO 107-0062 JAPAN';
            document.getElementById('exporterTel').value = generalInfo.exporterTel || '81-3-3498-1345';
            document.getElementById('exporterFax').value = generalInfo.exporterFax || '81-3-3486-7145';
            document.getElementById('pricePercentage').value = pricePercentage;
            
            document.getElementById('consigneeName').value = generalInfo.consigneeName || 'FENIX LOGISTIC SERVICES LIMITED';
            document.getElementById('consigneeAddress').value = generalInfo.consigneeAddress || '4/F, Chuan Kei Factory Building, 15-23 Kin Hong Street, Kwai Chung, N.T., Hong Kong';
            document.getElementById('consigneeContact').value = generalInfo.consigneeContact || 'Kawa (Mr.) / Kit (Mr.)';
            document.getElementById('consigneeTel').value = generalInfo.consigneeTel || '2127-4660';
            document.getElementById('consigneeEmail').value = generalInfo.consigneeEmail || 'fls.wh@fls.com.hk';
            
            document.getElementById('importerName').value = generalInfo.importerName || 'Heritage R LTD.';
            document.getElementById('importerAddress').value = generalInfo.importerAddress || '36/F, TOWER 2, THE GATEWAY, 25 CANTON ROAD, TSIM SHA TSUI, KOWLOON, HONG KONG';
            document.getElementById('importerTel').value = generalInfo.importerTel || '852-2956-3266';
            document.getElementById('importerFax').value = generalInfo.importerFax || '852-2956-1230';
        }

        function saveGeneralInfo() {
            pricePercentage = parseFloat(document.getElementById('pricePercentage').value) || 42;
            localStorage.setItem('pricePercentage', pricePercentage);
            
            generalInfo = {
                exporterName: document.getElementById('exporterName').value,
                exporterAddress: document.getElementById('exporterAddress').value,
                exporterTel: document.getElementById('exporterTel').value,
                exporterFax: document.getElementById('exporterFax').value,
                
                consigneeName: document.getElementById('consigneeName').value,
                consigneeAddress: document.getElementById('consigneeAddress').value,
                consigneeContact: document.getElementById('consigneeContact').value,
                consigneeTel: document.getElementById('consigneeTel').value,
                consigneeEmail: document.getElementById('consigneeEmail').value,
                
                importerName: document.getElementById('importerName').value,
                importerAddress: document.getElementById('importerAddress').value,
                importerTel: document.getElementById('importerTel').value,
                importerFax: document.getElementById('importerFax').value
            };
            localStorage.setItem('generalInfo', JSON.stringify(generalInfo));
            alert('保存しました / Saved successfully!');
            closeGeneralInfoModal();
        }
        
        function openPresetModal() {
            document.getElementById('presetModal').classList.add('active');
            renderPresets();
        }
        
        function closePresetModal() {
            document.getElementById('presetModal').classList.remove('active');
        }
        
        function renderPresets() {
            const container = document.getElementById('presetList');
            container.innerHTML = '';
            for (const [name, data] of Object.entries(presets)) {
                const item = document.createElement('div');
                item.className = 'preset-item';
                item.innerHTML = `
                    <div><label>Description</label><input type="text" value="${name}" data-field="name" data-original="${name}"></div>
                    <div><label>HS Code</label><input type="text" value="${data.hs_code}" data-field="hs_code" data-name="${name}"></div>
                    <div><label>Unit Value (JPY)</label><input type="number" value="${data.unit_value}" data-field="unit_value" data-name="${name}"></div>
                    <button class="btn-delete" onclick="deletePreset('${name}')"><i data-lucide="trash-2" size="18"></i></button>
                `;
                container.appendChild(item);
            }
            lucide.createIcons();
        }
        
        function addNewPreset() {
            const newName = `New Item ${Object.keys(presets).length + 1}`;
            presets[newName] = { hs_code: "", unit_value: 0, weight_per_unit: 0.1 };
            renderPresets();
        }
        
        function deletePreset(name) {
            if (confirm(`Delete "${name}"?`)) { delete presets[name]; renderPresets(); }
        }
        
        function savePresets() {
            const items = document.querySelectorAll('.preset-item');
            const newPresets = {};
            items.forEach(item => {
                const nameInput = item.querySelector('[data-field="name"]');
                const hsInput = item.querySelector('[data-field="hs_code"]');
                const valueInput = item.querySelector('[data-field="unit_value"]');
                const name = nameInput.value.trim();
                if (name) {
                    newPresets[name] = {
                        hs_code: hsInput.value.trim(),
                        unit_value: parseFloat(valueInput.value) || 0,
                        weight_per_unit: 0.1
                    };
                }
            });
            presets = newPresets;
            localStorage.setItem('invoicePresets', JSON.stringify(presets));
            alert('保存しました / Presets saved successfully!');
            closePresetModal();
            renderNoCommercialTable();
        }
        
        document.getElementById('presetModal').addEventListener('click', function(e) {
            if (e.target === this) closePresetModal();
        });

        document.getElementById('generalInfoModal').addEventListener('click', function(e) {
            if (e.target === this) closeGeneralInfoModal();
        });

        // ===== Invoice Preview Functions =====

        function openInvoicePreview(invoiceNo) {
            generateInvoiceHTML(invoiceNo);
            document.getElementById('invoicePreviewModal').classList.add('active');
            document.body.style.overflow = 'hidden'; // スクロール防止
            lucide.createIcons();
        }
        
        function closeInvoicePreview() {
            document.getElementById('invoicePreviewModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        function printInvoice() {
            window.print();
        }
        
        function generateInvoiceHTML(invoiceNo) {
            const doc = document.getElementById('invoiceDocument');
            
            // 日付フォーマット
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
            
            // General Info取得
            const exporter = {
                name: generalInfo.exporterName || '45RPM STUDIO Co.,Ltd.',
                address: generalInfo.exporterAddress || '7-2-1 MINAMIAOYAMA, MINATO-KU, TOKYO 107-0062 JAPAN',
                tel: generalInfo.exporterTel || '81-3-3498-1345',
                fax: generalInfo.exporterFax || '81-3-3486-7145'
            };
            
            const consignee = {
                name: generalInfo.consigneeName || 'FENIX LOGISTIC SERVICES LIMITED',
                address: generalInfo.consigneeAddress || '4/F, Chuan Kei Factory Building, 15-23 Kin Hong Street, Kwai Chung, N.T., Hong Kong',
                contact: generalInfo.consigneeContact || 'Kawa (Mr.) / Kit (Mr.)',
                tel: generalInfo.consigneeTel || '2127-4660',
                email: generalInfo.consigneeEmail || 'fls.wh@fls.com.hk'
            };
            
            const importer = {
                name: generalInfo.importerName || 'Heritage R LTD.',
                address: generalInfo.importerAddress || '36/F, TOWER 2, THE GATEWAY, 25 CANTON ROAD, TSIM SHA TSUI, KOWLOON, HONG KONG',
                tel: generalInfo.importerTel || '852-2956-3266',
                fax: generalInfo.importerFax || '852-2956-1230'
            };
            
            // 合計計算
            const totalPackages = productData.length + noCommercialData.length;
            const totalUnits = productData.reduce((sum, item) => sum + item.units, 0) + 
                               noCommercialData.reduce((sum, item) => sum + item.units, 0);
            const totalWeight = productData.reduce((sum, item) => sum + item.weight, 0) + 
                                noCommercialData.reduce((sum, item) => sum + item.weight, 0);
            const subtotal = productData.reduce((sum, item) => sum + item.totalValue, 0) + 
                             noCommercialData.reduce((sum, item) => sum + item.totalValue, 0);
            
            // 商品テーブル行生成
            let productRows = '';
            
            // Product Data
            productData.forEach(item => {
                productRows += `
                    <tr>
                        <td>1</td>
                        <td>${item.units}</td>
                        <td class="align-right">${item.weight.toFixed(2)}</td>
                        <td>${item.measure}</td>
                        <td>${item.description}</td>
                        <td>${item.hsCode}</td>
                        <td>${item.country}</td>
                        <td class="align-right">${item.unitValue.toLocaleString()}</td>
                        <td class="align-right">${item.totalValue.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            // No Commercial Data
            noCommercialData.forEach(item => {
                if (item.units > 0) {
                    productRows += `
                        <tr>
                            <td>1</td>
                            <td>${item.units}</td>
                            <td class="align-right">${item.weight.toFixed(2)}</td>
                            <td>${item.measure}</td>
                            <td>${item.description}</td>
                            <td>${item.hsCode}</td>
                            <td>${item.country}</td>
                            <td class="align-right">${item.unitValue.toLocaleString()}</td>
                            <td class="align-right">${item.totalValue.toLocaleString()}</td>
                        </tr>
                    `;
                }
            });
            
            // Remarks Section for Non-Commercial Items
            let nonCommercialNote = '';
            const nonCommItems = nonCommercialData.filter(item => item.description && item.quantity > 0);
            if (nonCommItems.length > 0) {
                const itemList = nonCommItems.map(item => `• ${item.description}: ${item.quantity} pcs`).join('<br>\n                        ');
                nonCommercialNote = `
                    <div class="invoice-notes">
                        <strong>REMARKS / 備考:</strong><br>
                        This shipment also contains the following non-commercial items<br>
                        (no commercial value / 無償提供品 - 金額には含まれません):<br>
                        <div style="margin-top: 0.5rem;">
                            ${itemList}
                        </div>
                    </div>
                `;
            }
            
            // HTML生成
            doc.innerHTML = `
                <div class="invoice-logo-header">
                    <img src="https://cdn.shopify.com/s/files/1/0666/5089/8714/files/45_logo.png?v=1684477634" 
                         alt="45RPM Studio" class="invoice-logo">
                    <div class="invoice-company-info">
                        <div class="invoice-company-name">45rpm Studio. co., ltd</div>
                        <div>Seiko Building, 7-2-1 Minami Aoyama, Minato-ku, Tokyo, Japan, 107-0062</div>
                    </div>
                </div>
                
                <div class="invoice-title-section">
                    <h1 class="invoice-title">Commercial Invoice</h1>
                    <div class="invoice-page-number">Page 1 of 1</div>
                </div>
                
                <div class="invoice-info-grid">
                    <div class="invoice-info-block">
                        <h4>EXPORTER:</h4>
                        <p><strong>${exporter.name}</strong></p>
                        <p>${exporter.address}</p>
                        <p><span class="invoice-info-label">TEL:</span> ${exporter.tel}</p>
                        <p><span class="invoice-info-label">FAX:</span> ${exporter.fax}</p>
                    </div>
                    
                    <div class="invoice-info-block">
                        <p><span class="invoice-info-label">Ship Date:</span> ${dateStr}</p>
                        <p><span class="invoice-info-label">Invoice No.:</span> ${invoiceNo}</p>
                        <p><span class="invoice-info-label">Payment Terms:</span> Bill 3rd Party</p>
                        <p><span class="invoice-info-label">Purpose of Shipment:</span> SOLD</p>
                        <p><span class="invoice-info-label">Currency Code:</span> JPY</p>
                    </div>
                    
                    <div class="invoice-info-block">
                        <h4>SOLD TO / IMPORTER:</h4>
                        <p><strong>${importer.name}</strong></p>
                        <p>${importer.address}</p>
                        <p><span class="invoice-info-label">TEL:</span> ${importer.tel}</p>
                        <p><span class="invoice-info-label">FAX:</span> ${importer.fax}</p>
                    </div>
                </div>
                
                <div class="invoice-info-grid" style="margin-top: 1rem;">
                    <div class="invoice-info-block">
                        <h4>CONSIGNEE:</h4>
                        <p><strong>${consignee.name}</strong></p>
                        <p>${consignee.address}</p>
                        <p><span class="invoice-info-label">Contact:</span> ${consignee.contact}</p>
                        <p><span class="invoice-info-label">TEL:</span> ${consignee.tel}</p>
                        <p><span class="invoice-info-label">Email:</span> ${consignee.email}</p>
                    </div>
                    <div class="invoice-info-block">
                        <p><span class="invoice-info-label">Parties to Transaction:</span> Non-Related</p>
                    </div>
                </div>
                
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">No. of Pkgs</th>
                            <th style="width: 7%;">No. of Units</th>
                            <th style="width: 8%;">Net Weight (KG)</th>
                            <th style="width: 8%;">Unit of Measure</th>
                            <th style="width: 22%;">Description of Goods</th>
                            <th style="width: 12%;">Harmonized Tariff Number</th>
                            <th style="width: 10%;">Country/Terr. of MFR</th>
                            <th style="width: 12%;">Unit Value (JPY)</th>
                            <th style="width: 12%;">Total Value (JPY)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productRows}
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: 600; background-color: #f3f4f6;">
                            <td>${totalPackages}</td>
                            <td>${totalUnits}</td>
                            <td class="align-right">${totalWeight.toFixed(2)} KG</td>
                            <td colspan="5"></td>
                            <td class="align-right"></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="invoice-totals">
                    <table class="invoice-totals-table">
                        <tr>
                            <td>Subtotal:</td>
                            <td>JPY ${subtotal.toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td>Insurance:</td>
                            <td>0.00</td>
                        </tr>
                        <tr>
                            <td>Freight:</td>
                            <td>0.00</td>
                        </tr>
                        <tr>
                            <td>Packing:</td>
                            <td>0.00</td>
                        </tr>
                        <tr>
                            <td>Handling:</td>
                            <td>0.00</td>
                        </tr>
                        <tr>
                            <td>Other:</td>
                            <td>0.00</td>
                        </tr>
                        <tr>
                            <td>Invoice Total:</td>
                            <td>JPY ${subtotal.toLocaleString()}</td>
                        </tr>
                    </table>
                </div>
                
                ${nonCommercialNote}
                
                <div class="invoice-footer">
                    <div class="invoice-declaration">
                        <strong>Declaration Statement:</strong><br>
                        I declare that all the information contained in this invoice to be true and correct.
                    </div>
                    
                    <div class="invoice-signature">
                        <div class="invoice-signature-line">
                            Signature / Title / Date: ${dateStr}
                        </div>
                        <div class="invoice-signature-line">
                            ${exporter.name}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // モーダル外クリックで閉じる
        document.getElementById('invoicePreviewModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeInvoicePreview();
        });
    </script>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="invoice-preview-modal">
        <div class="invoice-preview-header">
            <div class="invoice-preview-title">📄 Invoice Preview</div>
            <div class="invoice-preview-actions">
                <button class="btn btn-back" onclick="closeInvoicePreview()">
                    <i data-lucide="arrow-left" size="18"></i>
                    戻る / Back
                </button>
                <button class="btn btn-print" onclick="printInvoice()">
                    <i data-lucide="printer" size="18"></i>
                    印刷 / Print
                </button>
                <button class="btn btn-primary btn-disabled" disabled>
                    <i data-lucide="file-down" size="18"></i>
                    PDF
                </button>
                <button class="btn btn-primary btn-disabled" disabled>
                    <i data-lucide="file-spreadsheet" size="18"></i>
                    Excel
                </button>
            </div>
        </div>
        
        <div class="invoice-preview-container">
            <div class="invoice-document" id="invoiceDocument">
                <!-- Invoice content will be generated here -->
            </div>
        </div>
    </div>
</body>
</html>
